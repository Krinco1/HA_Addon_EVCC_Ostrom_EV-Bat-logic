---
phase: 04.1-deploy-configuration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - evcc-smartload/rootfs/app/version.py
  - evcc-smartload/config.yaml
  - repository.yaml
  - evcc-smartload/translations/en.yaml
  - evcc-smartload/translations/de.yaml
autonomous: true
gap_closure: true
requirements:
  - DEPLOY-02
  - DEPLOY-03
  - DEPLOY-05
must_haves:
  truths:
    - "version.py and config.yaml both declare version 6.0.0"
    - "All 8 LP planner config fields are exposed in config.yaml options and schema sections"
    - "repository.yaml includes channel: stable"
    - "Both translation files (en.yaml, de.yaml) have entries for all 8 new fields"
  artifacts:
    - path: "evcc-smartload/rootfs/app/version.py"
      provides: "Version source of truth"
      contains: 'VERSION = "6.0.0"'
    - path: "evcc-smartload/config.yaml"
      provides: "HA add-on config with version 6.0.0 and 30 schema fields"
      contains: "battery_min_soc"
    - path: "repository.yaml"
      provides: "Repository metadata with stable channel"
      contains: "channel: stable"
    - path: "evcc-smartload/translations/en.yaml"
      provides: "English labels for all 30 config fields"
      contains: "battery_charge_power_kw"
    - path: "evcc-smartload/translations/de.yaml"
      provides: "German labels for all 30 config fields"
      contains: "battery_charge_power_kw"
  key_links:
    - from: "evcc-smartload/config.yaml options block"
      to: "evcc-smartload/config.yaml schema block"
      via: "field names must match 1:1"
      pattern: "battery_charge_power_kw.*battery_min_soc.*battery_max_soc"
    - from: "evcc-smartload/config.yaml options block"
      to: "evcc-smartload/translations/en.yaml"
      via: "every options field must have a translation entry"
      pattern: "battery_charge_power_kw"
    - from: "evcc-smartload/rootfs/app/version.py"
      to: "evcc-smartload/config.yaml version line"
      via: "version strings must be identical"
      pattern: "6\\.0\\.0"
---

<objective>
Bump version to 6.0.0, complete the config.yaml schema with all 8 missing LP planner fields, add channel: stable to repository.yaml, and update both translation files — closing DEPLOY-02, DEPLOY-03, DEPLOY-05 from v1.0 audit.

Purpose: Make the HA add-on deployable with correct version, complete user-configurable LP planner fields in HA UI, and proper repository metadata.
Output: Five files updated — version.py, config.yaml, repository.yaml, translations/en.yaml, translations/de.yaml.
</objective>

<execution_context>
@C:/Users/nicok/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/nicok/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04.1-deploy-configuration/04.1-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Version bump and repository metadata</name>
  <files>
    evcc-smartload/rootfs/app/version.py
    evcc-smartload/config.yaml
    repository.yaml
  </files>
  <action>
1. In `evcc-smartload/rootfs/app/version.py`, change `VERSION = "5.0.7"` to `VERSION = "6.0.0"`.

2. In `evcc-smartload/config.yaml`:
   - Change line 3 `version: "5.0.7"` to `version: "6.0.0"`.
   - Update the `description:` line to reflect v6.0 capabilities. Replace:
     `"Hybrid LP+RL · Percentil-Thresholds · Charge-Sequencer · Telegram-Notifications · Quiet Hours · Batterie→EV"`
     with:
     `"LP Horizon Planner · PV+Consumption Forecasting · Charge-Sequencer · RL Agent · Telegram · Quiet Hours · Batterie→EV"`
   - Add the 8 missing fields to the `options:` block, inserting them into logical groups:
     - After `battery_to_ev_floor_soc: 20` (battery group), add:
       ```
       battery_charge_power_kw: 4.3
       battery_min_soc: 10
       battery_max_soc: 90
       feed_in_tariff_ct: 7.0
       ```
     - After `ev_charge_deadline_hour: 6` (EV group), add:
       ```
       ev_default_energy_kwh: 30.0
       ```
     - After `ev_default_energy_kwh: 30.0`, add a new sequencer section:
       ```
       sequencer_enabled: true
       sequencer_default_charge_power_kw: 11.0
       ```
     - After `rl_ready_min_comparisons: 200` (RL group), add:
       ```
       rl_bootstrap_max_records: 1000
       ```
   - Add matching entries to the `schema:` block in the SAME order:
     - After `battery_to_ev_floor_soc:` entry, add:
       ```
       battery_charge_power_kw: "float(0,)"
       battery_min_soc: "int(0,100)"
       battery_max_soc: "int(0,100)"
       feed_in_tariff_ct: "float(0,)"
       ```
     - After `ev_charge_deadline_hour:` entry, add:
       ```
       ev_default_energy_kwh: "float(0,)"
       ```
     - After `ev_default_energy_kwh:` entry, add:
       ```
       sequencer_enabled: bool
       sequencer_default_charge_power_kw: "float(0,)"
       ```
     - After `rl_ready_min_comparisons:` entry, add:
       ```
       rl_bootstrap_max_records: "int(1,)"
       ```

   IMPORTANT: Use bare `true` (not quoted) for the `sequencer_enabled` option value. Use `bool` (not `bool?`) for its schema type since it has a default.

3. In `repository.yaml`, add `channel: stable` after the `maintainer:` line.

4. Verify main.py line ~47 uses `f"  EVCC-Smartload v{VERSION}"` dynamically. If so, no main.py edit needed — it picks up the version.py change automatically. Do NOT modify main.py unless a hardcoded version string is found.
  </action>
  <verify>
    Run: `grep -n "6.0.0" evcc-smartload/rootfs/app/version.py evcc-smartload/config.yaml` — both files must show 6.0.0.
    Run: `grep -c "battery_charge_power_kw\|battery_min_soc\|battery_max_soc\|feed_in_tariff_ct\|ev_default_energy_kwh\|sequencer_enabled\|sequencer_default_charge_power_kw\|rl_bootstrap_max_records" evcc-smartload/config.yaml` — must return 16 (8 in options + 8 in schema).
    Run: `grep "channel" repository.yaml` — must show `channel: stable`.
  </verify>
  <done>version.py and config.yaml both declare 6.0.0; config.yaml has 30 options and 30 schema entries (22 existing + 8 new); repository.yaml has channel: stable</done>
</task>

<task type="auto">
  <name>Task 2: Translation files for new config fields</name>
  <files>
    evcc-smartload/translations/en.yaml
    evcc-smartload/translations/de.yaml
  </files>
  <action>
1. In `evcc-smartload/translations/en.yaml`, add 8 entries inside the `configuration:` block, inserted in the SAME logical grouping order as config.yaml:

   After `battery_to_ev_floor_soc:` entry (battery group), add:
   ```yaml
     battery_charge_power_kw:
       name: Battery Charge Power (kW)
       description: Maximum charging power of the home battery in kW
     battery_min_soc:
       name: Battery Min SoC (%)
       description: Minimum battery state of charge — LP planner will not discharge below this
     battery_max_soc:
       name: Battery Max SoC (%)
       description: Maximum battery state of charge — LP planner will not charge above this
     feed_in_tariff_ct:
       name: Feed-in Tariff (ct/kWh)
       description: Revenue per kWh for feeding solar into the grid — used in LP objective
   ```

   After `ev_charge_deadline_hour:` entry (EV group), add:
   ```yaml
     ev_default_energy_kwh:
       name: EV Default Energy (kWh)
       description: Fallback EV battery capacity when real capacity is unknown
   ```

   After `ev_default_energy_kwh:` entry, add:
   ```yaml
     sequencer_enabled:
       name: Charge Sequencer Enabled
       description: Enable multi-EV charge sequencing (one EV at a time on shared wallbox)
     sequencer_default_charge_power_kw:
       name: Sequencer Default Charge Power (kW)
       description: Default charge power used by sequencer when vehicle-specific power is unavailable
   ```

   After `rl_ready_min_comparisons:` entry (RL group), add:
   ```yaml
     rl_bootstrap_max_records:
       name: RL Bootstrap Max Records
       description: Maximum InfluxDB records loaded during RL agent bootstrap to cap memory use
   ```

2. In `evcc-smartload/translations/de.yaml`, add the same 8 entries with German translations, in the same positions:

   After `battery_to_ev_floor_soc:` entry:
   ```yaml
     battery_charge_power_kw:
       name: Batterie-Ladeleistung (kW)
       description: Maximale Ladeleistung der Hausbatterie in kW
     battery_min_soc:
       name: Batterie Min-SoC (%)
       description: Minimaler Batterie-Ladezustand — LP-Planer entlädt nicht darunter
     battery_max_soc:
       name: Batterie Max-SoC (%)
       description: Maximaler Batterie-Ladezustand — LP-Planer lädt nicht darüber hinaus
     feed_in_tariff_ct:
       name: Einspeisevergütung (ct/kWh)
       description: Vergütung je kWh für Solareinspeisung — wird im LP-Optimierungsziel verwendet
   ```

   After `ev_charge_deadline_hour:` entry:
   ```yaml
     ev_default_energy_kwh:
       name: EV Standard-Energie (kWh)
       description: Fallback-Batteriekapazität des EV wenn echte Kapazität unbekannt
   ```

   After `ev_default_energy_kwh:` entry:
   ```yaml
     sequencer_enabled:
       name: Charge Sequencer aktiviert
       description: Mehrfach-EV-Ladesequenzierung aktivieren (ein EV gleichzeitig an gemeinsamer Wallbox)
     sequencer_default_charge_power_kw:
       name: Sequencer Standard-Ladeleistung (kW)
       description: Standard-Ladeleistung des Sequencers wenn fahrzeugspezifische Leistung nicht verfügbar
   ```

   After `rl_ready_min_comparisons:` entry:
   ```yaml
     rl_bootstrap_max_records:
       name: RL Bootstrap Max. Datensätze
       description: Maximale InfluxDB-Datensätze beim RL-Bootstrap zur Speicherbegrenzung
   ```

Follow the existing pattern: 2-space indent for field name, 4-space indent for name/description. Use `(unit)` suffix in `name` for numeric fields with units (existing convention).
  </action>
  <verify>
    Run: `grep -c "battery_charge_power_kw\|battery_min_soc\|battery_max_soc\|feed_in_tariff_ct\|ev_default_energy_kwh\|sequencer_enabled\|sequencer_default_charge_power_kw\|rl_bootstrap_max_records" evcc-smartload/translations/en.yaml` — must return 8.
    Run: `grep -c "battery_charge_power_kw\|battery_min_soc\|battery_max_soc\|feed_in_tariff_ct\|ev_default_energy_kwh\|sequencer_enabled\|sequencer_default_charge_power_kw\|rl_bootstrap_max_records" evcc-smartload/translations/de.yaml` — must return 8.
  </verify>
  <done>Both en.yaml and de.yaml have entries for all 30 config fields (22 existing + 8 new), with proper English and German translations following existing naming conventions</done>
</task>

</tasks>

<verification>
1. **Version consistency (DEPLOY-02):** `grep "6.0.0" evcc-smartload/rootfs/app/version.py evcc-smartload/config.yaml` — both files show 6.0.0
2. **Config schema completeness (DEPLOY-03):** Count options and schema entries in config.yaml — both must have 30 entries (22 existing + 8 new). All 8 missing fields: battery_charge_power_kw, battery_min_soc, battery_max_soc, feed_in_tariff_ct, ev_default_energy_kwh, sequencer_enabled, sequencer_default_charge_power_kw, rl_bootstrap_max_records
3. **Repository metadata (DEPLOY-05):** `grep "channel: stable" repository.yaml` returns match
4. **Translation completeness:** Both en.yaml and de.yaml have 30 configuration entries each
5. **Options/schema parity:** Every field in options block has a matching schema entry and vice versa
6. **No runtime changes:** No Python files other than version.py were modified; no tests needed
</verification>

<success_criteria>
- DEPLOY-02 closed: version.py and config.yaml both declare 6.0.0
- DEPLOY-03 closed: All 8 LP planner config fields exposed in config.yaml options + schema, with translations in both en.yaml and de.yaml
- DEPLOY-05 closed: repository.yaml includes channel: stable
- All options have matching schema entries (30/30 parity)
- All options have matching translation entries in both languages (30/30 parity)
- No runtime Python code changed (zero risk of behavior regression)
</success_criteria>

<output>
After completion, create `.planning/phases/04.1-deploy-configuration/04.1-01-SUMMARY.md`
</output>
