---
phase: 04.3-release-documentation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - CHANGELOG.md
  - evcc-smartload/CHANGELOG.md
  - README.md
  - evcc-smartload/README.md
autonomous: true
requirements: [DEPLOY-04]

must_haves:
  truths:
    - "CHANGELOG.md has version entries for v5.1 (Phase 1+2), v5.2 (Phase 3), and v6.0 (Phase 4+4.1+4.2) covering all features built in Phases 1-4"
    - "README.md architecture section describes the v6 system: StateStore, ConsumptionForecaster, PVForecaster, HorizonPlanner LP engine, and SSE push"
    - "README.md API table lists all endpoints including /forecast, /events, /health, and all v5+v6 endpoints"
    - "README.md version references are updated from 5.0 to 6.0"
    - "Both root-level and evcc-smartload/ copies are updated consistently"
  artifacts:
    - path: "CHANGELOG.md"
      provides: "Root changelog with v5.1-v6.0 entries"
      contains: "v6.0"
    - path: "evcc-smartload/CHANGELOG.md"
      provides: "Add-on changelog with v5.1-v6.0 entries"
      contains: "v6.0"
    - path: "README.md"
      provides: "Root README with updated version and feature list"
      contains: "6.0"
    - path: "evcc-smartload/README.md"
      provides: "Add-on README with architecture, API table, v6 features"
      contains: "HorizonPlanner"
  key_links:
    - from: "CHANGELOG.md"
      to: "evcc-smartload/CHANGELOG.md"
      via: "content parity"
      pattern: "v6\\.0"
    - from: "README.md"
      to: "evcc-smartload/README.md"
      via: "content parity for feature list"
      pattern: "6\\.0"
---

<objective>
Update CHANGELOG.md and README.md to accurately document all features, architecture changes, and API endpoints introduced in Phases 1-4 (v5.1 through v6.0).

Purpose: DEPLOY-04 gap closure — documentation is stale at v5.0.2 but codebase is at v6.0.0 with major new subsystems (StateStore, forecasters, LP planner, SSE, config validation).

Output: Updated CHANGELOG.md and README.md in both root and evcc-smartload/ directories.
</objective>

<execution_context>
@C:/Users/nicok/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/nicok/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Source files to understand what was actually built:
@evcc-smartload/rootfs/app/state_store.py
@evcc-smartload/rootfs/app/config_validator.py
@evcc-smartload/rootfs/app/forecaster/consumption.py
@evcc-smartload/rootfs/app/forecaster/pv.py
@evcc-smartload/rootfs/app/optimizer/planner.py
@evcc-smartload/rootfs/app/web/server.py
@evcc-smartload/rootfs/app/main.py
@evcc-smartload/rootfs/app/version.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update CHANGELOG.md with v5.1 through v6.0 entries</name>
  <files>CHANGELOG.md, evcc-smartload/CHANGELOG.md</files>
  <action>
Add three new version entries ABOVE the existing v5.0.2 entry in both CHANGELOG.md files (root and evcc-smartload/). All text in German (matching existing changelog style). Use the existing changelog format (heading style, section grouping).

**v6.0.0 — Predictive LP Planner + PV/Consumption Forecasting + Config Validation**

New features section:
- **HorizonPlanner (LP-basierter 24h Optimizer)**: Rolling-Horizon Linear Programming mit scipy/HiGHS. 96-Slot (15-Min) Joint Battery+EV Dispatch. Ersetzt statische Euro-Preislimits durch dynamische planbasierte Optimierung. MPC-Ansatz: nur Slot-0-Entscheidung wird angewendet, LP wird jeden Zyklus neu geloest.
- **ConsumptionForecaster**: Hour-of-day Rolling-Average (EMA) aus InfluxDB-Historie. Tiered Bootstrap: 7d@15min + 8-30d@hourly. Persistentes JSON-Modell unter /data/. Correction Factor [0.5-1.5] fuer Echtzeit-Anpassung.
- **PVForecaster**: PV-Ertragsprognose via evcc Solar Tariff API (/api/tariff/solar). Rolling Correction Coefficient [0.3-3.0] mit Daytime-Guard. Stuendliche Aktualisierung. Confidence 0.0-1.0 basierend auf Datenabdeckung.
- **StateStore (Thread-Safe State Management)**: RLock-geschuetzter Single Source of Truth. Atomare Snapshots fuer Web-Server (read-only). SSE-Broadcast nach jedem Update (ausserhalb des Locks).
- **SSE Endpoint /events**: Server-Sent Events fuer Live-Dashboard-Updates ohne Polling. ThreadedHTTPServer mit Daemon-Threads. 30s Keepalive.
- **Config Validation**: ConfigValidator prueft alle Felder beim Start. Kritische Fehler blockieren Start mit HTML-Fehlerseite auf Port 8099. Nicht-kritische Warnungen setzen sichere Defaults.
- **GET /forecast Endpoint**: 96-Slot Verbrauchs- und PV-Prognose mit Confidence, Correction-Label, Quality-Label, Price-Zones.

Architecture changes section:
- Web-Server ist jetzt strikt read-only (alle Reads via StateStore.snapshot())
- Main Loop schreibt ueber store.update() — kein direkter State-Zugriff mehr
- HorizonPlanner als primaerer Optimizer, HolisticOptimizer als Fallback bei LP-Fehler
- Forecaster-Package (forecaster/) mit ConsumptionForecaster und PVForecaster
- ThreadedHTTPServer ersetzt einfachen HTTPServer (SSE-Kompatibilitaet)

Config changes section:
- Neue config.yaml Felder: battery_charge_power_kw, battery_min_soc, battery_max_soc, feed_in_tariff_ct, ev_default_energy_kwh, sequencer_enabled, sequencer_default_charge_power_kw, rl_bootstrap_max_records
- Version: 6.0.0
- repository.yaml: channel: stable

CI/CD section:
- GitHub Actions Workflow fuer Multi-Arch Dockerfile Build-Test
- home-assistant/builder@2025.09.0 mit --test Flag
- HA Supervisor baut lokal aus Dockerfile (Standard-Add-on-Modell)

Backward compatibility section:
- Bestehende config.yaml-Felder bleiben kompatibel
- HolisticOptimizer bleibt als automatischer Fallback aktiv
- Alle v5 API-Endpoints unveraendert

**v5.2.0 — Verbrauchs- und PV-Prognose (Data Foundation)**

- ConsumptionForecaster: Hausverbrauch aus InfluxDB-Historie mit EMA-Modell
- PVForecaster: PV-Ertrag via evcc Solar Tariff API
- Forecaster in Main Loop integriert (15-Min Updates, stuendliche PV-Aktualisierung)
- StateStore um Forecast-Felder erweitert (consumption_forecast, pv_forecast, pv_confidence, etc.)
- Dashboard: 24h Forecast-Diagramm mit SSE-Live-Updates

**v5.1.0 — Thread-Safe StateStore + Config Validation + Vehicle Reliability**

- StateStore: Thread-safe RLock-geschuetzter State mit atomaren Snapshots
- SSE Push: /events Endpoint fuer Live-Dashboard-Updates
- ConfigValidator: Startup-Validierung mit kritisch/nicht-kritisch Klassifizierung
- HTML-Fehlerseite bei kritischen Config-Fehlern (vor Main Loop Start)
- Vehicle SoC Refresh bei Wallbox-Verbindung (Connection-Event-basiert)
- Charge Sequencer SoC-Sync im Decision Loop (sofortige Uebergabe)
- RL Bootstrap mit Record-Cap (rl_bootstrap_max_records) und Progress-Logging
- RL Bootstrap Price-Field Fix (korrekte ct->EUR Konversion)

Ensure the changelog entries are inserted before the existing v5.0.2 entry. Both files (root CHANGELOG.md and evcc-smartload/CHANGELOG.md) must have the same new entries.
  </action>
  <verify>
    <automated>cd C:/users/nicok/projects/smartload && grep -c "v6.0.0" CHANGELOG.md && grep -c "v5.2.0" CHANGELOG.md && grep -c "v5.1.0" CHANGELOG.md && grep -c "v6.0.0" evcc-smartload/CHANGELOG.md && grep -c "v5.2.0" evcc-smartload/CHANGELOG.md && grep -c "v5.1.0" evcc-smartload/CHANGELOG.md</automated>
    <manual>Verify changelog entries are in correct reverse-chronological order and cover all Phase 1-4 features</manual>
  </verify>
  <done>Both CHANGELOG.md files have entries for v5.1.0, v5.2.0, and v6.0.0 with all Phase 1-4 features documented in German</done>
</task>

<task type="auto">
  <name>Task 2: Update README.md with v6 architecture, API table, and features</name>
  <files>README.md, evcc-smartload/README.md</files>
  <action>
Update both README.md files (root and evcc-smartload/) to reflect v6.0.0. Write in German (matching existing style). All version references updated from 5.0 to 6.0.

**Root README.md updates:**
1. Update the version in the add-on table from "5.0.2" to "6.0.0"
2. Update the description to mention predictive LP planner and forecasting
3. Update the features list to include: StateStore (thread-safe), ConsumptionForecaster (InfluxDB), PVForecaster (evcc solar), HorizonPlanner (LP 24h), SSE Live-Updates (/events), Config Validation (startup error page), /forecast API endpoint

**evcc-smartload/README.md updates:**

1. Update title from "v5.0" to "v6.0"
2. Update description to mention predictive 24h planning

3. **Features table** — add new rows:
   - **24h LP-Planner** | Rolling-Horizon LP (scipy/HiGHS) optimiert Battery+EV gemeinsam ueber 96 Slots (15-Min)
   - **Verbrauchsprognose** | Hour-of-day EMA aus InfluxDB-Historie, persistentes Modell, Echtzeit-Korrektur
   - **PV-Prognose** | evcc Solar Tariff API, Rolling Correction [0.3-3.0], stuendliche Aktualisierung
   - **StateStore** | Thread-safe RLock, atomare Snapshots, SSE-Broadcast
   - **SSE Live-Updates** | /events Endpoint, kein Polling, 30s Keepalive
   - **Config Validation** | Startup-Pruefung, HTML-Fehlerseite bei kritischen Fehlern

4. **Architecture section** — replace the v5.0 ASCII art with v6 architecture:
```
Strompreise (24h)  ──┐
Verbrauchsprognose ──┤
PV-Prognose       ──┼──→ HorizonPlanner (LP/HiGHS)
Batterie-SoC      ──┤         ↓
EV-SoC + Deadline ──┘    PlanHorizon (96 Slots)
                              ↓
                    ┌─── Slot 0 Entscheidung ───┐
                    ↓                           ↓
              Batterie-Aktion            EV-Aktion
              (charge/discharge/hold)    (charge/off)
                    ↓                           ↓
              Controller ──→ evcc API ──→ Wallbox/Batterie
                    ↓
              StateStore ──→ SSE /events ──→ Dashboard
```

   Below the diagram, add a brief paragraph explaining:
   - HorizonPlanner solves a 96-slot LP every 15-min cycle (MPC approach)
   - Only slot-0 decision applied; LP re-solved from actual SoC next cycle
   - HolisticOptimizer is automatic fallback on LP failure
   - StateStore is RLock-guarded single source of truth; web server read-only via snapshot()
   - ConsumptionForecaster uses EMA from InfluxDB (tiered: 7d@15min, 8-30d@hourly)
   - PVForecaster reads evcc solar tariff API hourly with correction coefficient

5. **API table** — add these new endpoints to the existing table:
   - GET /events — v6: SSE-Stream fuer Live-Updates (Server-Sent Events)
   - GET /forecast — v6: 96-Slot Verbrauchs- und PV-Prognose mit Confidence
   - GET /health — Heartbeat mit Version (was in v5 schon da, sicherstellen dass es in der Tabelle steht)

6. **Config section** — add the new v6 config fields:
   ```yaml
   battery_charge_power_kw: 5.0    # Max Ladeleistung Batterie in kW
   battery_min_soc: 10             # Min SoC in % (LP-Untergrenze)
   battery_max_soc: 90             # Max SoC in % (LP-Obergrenze)
   feed_in_tariff_ct: 7.0          # Einspeiseverguetung ct/kWh
   ev_default_energy_kwh: 60       # Default EV-Kapazitaet wenn unbekannt
   sequencer_enabled: true         # Charge Sequencer aktiv
   sequencer_default_charge_power_kw: 11.0  # Default Ladeleistung EV
   rl_bootstrap_max_records: 1000  # Max Records fuer RL Bootstrap
   ```

7. Update version references throughout (5.0 -> 6.0, 5.0.1 -> 6.0.0 etc.)

8. Update "Wichtige Hinweise" section to mention:
   - HorizonPlanner ist primaerer Optimizer (LP); HolisticOptimizer nur Fallback
   - StateStore garantiert Thread-Safety (kein Race Condition moeglich)
   - Forecaster brauchen 24h Daten bevor sie bereit sind (is_ready Gate)
  </action>
  <verify>
    <automated>cd C:/users/nicok/projects/smartload && grep -c "HorizonPlanner" evcc-smartload/README.md && grep -c "/forecast" evcc-smartload/README.md && grep -c "/events" evcc-smartload/README.md && grep -c "6.0" README.md && grep -c "StateStore" evcc-smartload/README.md</automated>
    <manual>Verify architecture diagram renders correctly, API table is complete, version references are consistent</manual>
  </verify>
  <done>Both README.md files updated to v6.0 with architecture section (StateStore, forecasters, HorizonPlanner, LP dispatch), complete API table (/forecast, /events, all endpoints), and correct version references</done>
</task>

</tasks>

<verification>
1. `grep -c "v6.0.0" CHANGELOG.md` returns >= 1 (version entry exists)
2. `grep -c "v5.1.0" CHANGELOG.md` returns >= 1 (Phase 1+2 entry exists)
3. `grep -c "v5.2.0" CHANGELOG.md` returns >= 1 (Phase 3 entry exists)
4. `grep -c "HorizonPlanner" evcc-smartload/README.md` returns >= 1 (architecture documented)
5. `grep -c "/forecast" evcc-smartload/README.md` returns >= 1 (API endpoint listed)
6. `grep -c "/events" evcc-smartload/README.md` returns >= 1 (SSE endpoint listed)
7. `grep "6.0" README.md` shows version updated in root README
8. Root and add-on CHANGELOG.md have matching new entries
</verification>

<success_criteria>
- CHANGELOG.md has entries for v5.1.0, v5.2.0, and v6.0.0 covering all Phase 1-4 features
- README.md architecture section describes StateStore, ConsumptionForecaster, PVForecaster, HorizonPlanner, and LP dispatch flow
- README.md API table lists /forecast, /events, and all other endpoints (both v5 and v6)
- All version references updated from 5.0 to 6.0
- Both root and evcc-smartload/ copies are consistent
</success_criteria>

<output>
After completion, create `.planning/phases/04.3-release-documentation/04.3-01-SUMMARY.md`
</output>
