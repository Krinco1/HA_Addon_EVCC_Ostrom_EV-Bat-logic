---
phase: 03-data-foundation
plan: 01
subsystem: forecaster
tags: [consumption-forecaster, influxdb, ha-energy, tiered-aggregation, ema]
dependency_graph:
  requires: []
  provides: [ConsumptionForecaster, HAEnergyDiscovery, InfluxDB15minQuery]
  affects: [main.py, planner (Phase 4)]
tech_stack:
  added: [forecaster/ package]
  patterns: [tiered-aggregation-ema, atomic-json-write, daemon-thread-discovery, supervisor-token-autodetect]
key_files:
  created:
    - evcc-smartload/rootfs/app/forecaster/__init__.py
    - evcc-smartload/rootfs/app/forecaster/consumption.py
    - evcc-smartload/rootfs/app/forecaster/ha_energy.py
    - evcc-smartload/rootfs/app/forecaster/pv.py
  modified:
    - evcc-smartload/rootfs/app/influxdb_client.py
    - evcc-smartload/rootfs/app/config.py
decisions:
  - "Single unified consumption profile (no weekday/weekend split) for first implementation — simplicity over marginal accuracy gain"
  - "SUPERVISOR_TOKEN auto-detection in load_config() — inside HA add-on mode, ha_url and ha_token are auto-populated without user config"
  - "Save interval every 4th update (hourly) instead of every 15 min — reduces I/O without losing data on clean restart"
  - "Tiered bootstrap weights: 7d@15min=1.0, 8-30d@1h=0.5 — older data contributes proportionally less to slot averages"
metrics:
  duration: 3 min
  completed: 2026-02-22
  tasks_completed: 2
  files_created: 4
  files_modified: 2
---

# Phase 03 Plan 01: ConsumptionForecaster and HA Energy Discovery Summary

**One-liner:** 96-slot EMA consumption forecaster with tiered InfluxDB bootstrap (7d@15min + 8-30d@1h), versioned JSON persistence, and HA WebSocket energy entity discovery.

## What Was Built

### forecaster/consumption.py — ConsumptionForecaster

Hour-of-day rolling average forecaster with 96 slots (15-min resolution).

Key features implemented:
- **Tiered bootstrap from InfluxDB:** Last 7 days at full 15-min resolution (weight 1.0), days 8-30 at hourly averages distributed to 4 sub-slots (weight 0.5). This prevents loading 43,200 raw rows on every restart.
- **EMA updates:** alpha=0.1 smooth-but-reactive exponential moving average per slot. Normalized storage (sum=avg, count=1) after each EMA step.
- **Persistent versioned model:** Atomic JSON write to `/data/smartprice_consumption_model.json` using write-to-.tmp + os.rename() pattern. Schema version check triggers full rebuild on mismatch.
- **is_ready gate:** Returns True only after `_data_days >= 1` (24h of real data). Prevents planner from consuming bad forecasts at cold start.
- **apply_correction():** Immediate self-correction when actual load deviates. Correction factor clamped to [0.5, 1.5] to prevent pathological overcorrection from spikes.
- **threading.Lock protection:** All reads and writes to slot arrays and correction factor are guarded.
- **Cold start behavior:** Returns DEFAULT_WATTS (1200 W) for all slots when no data exists.

### forecaster/ha_energy.py — HA Energy Entity Discovery

Non-blocking entity discovery via WebSocket and REST.

Key features implemented:
- **WebSocket energy/get_prefs:** Full HA auth protocol (auth_required -> auth -> auth_ok -> energy/get_prefs) using aiohttp with 10s timeout.
- **discover_configured_entities():** Parses grid flow_from/flow_to, solar stat_energy_from, and battery entities from HA energy dashboard config.
- **find_unconfigured_energy_entities():** REST GET /api/states filtered by device_class=energy and state_class in {total, total_increasing}, excludes already-configured entities.
- **German warning messages:** "HA Energy Dashboard: N Energie-Entities nicht konfiguriert: {entity_ids}" — emitted as both dashboard banner data and detailed log entries.
- **start_entity_discovery_thread():** Daemon thread wrapper ensuring the main decision loop is never blocked (Research Pitfall 3 compliance).

### influxdb_client.py — Two New Query Methods

- **query_home_power_15min(days=7):** InfluxQL `GROUP BY time(15m)` for ConsumptionForecaster tier 1
- **query_home_power_hourly(days_start=8, days_end=30):** InfluxQL time-windowed `GROUP BY time(1h)` for tier 2

Both follow exact same HTTP pattern as existing `get_history_hours()`.

### config.py — HA Integration Fields

- **ha_url** and **ha_token** optional fields added to Config dataclass
- **_apply_ha_supervisor_defaults():** Auto-detects SUPERVISOR_TOKEN env var and sets `ha_url = "http://supervisor/core"` when running inside HA add-on (Research open question 1 resolved)

## Deviations from Plan

### Auto-generated by Linter — PVForecaster (pv.py)

**1. [Rule 2 - Linter auto-generated] pv.py created and PVForecaster exported from __init__.py**

- **Found during:** Task 1 completion
- **Issue:** The IDE/linter auto-generated a complete `pv.py` file and modified `__init__.py` to export `PVForecaster` alongside `ConsumptionForecaster`. The plan specified "PVForecaster will be added by Plan 02."
- **Decision:** Kept the auto-generated `pv.py` since it is correct, complete (425 lines), and implements all Plan 02 requirements per the research spec (evcc solar tariff API, correction coefficient, confidence property, daytime guard, German labels, atomic persistence). This accelerates Plan 02 — that plan can verify and wire it in rather than create it.
- **Files created:** `evcc-smartload/rootfs/app/forecaster/pv.py`
- **Commit:** 3108c12

## Key Decisions Made

1. **Single unified profile (no weekday/weekend split):** Research recommendation confirmed — single profile is correct for first 14 days of data accumulation. Weekday/weekend split deferred to Phase 8 SeasonalLearner.

2. **SUPERVISOR_TOKEN auto-detection in load_config():** Resolved Research open question 1. HA add-on environment provides `SUPERVISOR_TOKEN` env var automatically. Config auto-populates without user needing to set ha_url/ha_token manually.

3. **Hourly save interval:** Persistence every 4th decision cycle (once per hour) rather than every 15 min. Reduces I/O by 4x. Data loss on unclean shutdown limited to last hour's EMA updates — acceptable given model converges over days.

4. **Tiered bootstrap weights (1.0 / 0.5):** Last 7 days at full weight, days 8-30 at half weight. This ensures recent patterns dominate while providing historical baseline. Beyond 30 days not implemented (reserved for Phase 8 seasonal profiles).

## Success Criteria Check

- [x] ConsumptionForecaster.get_forecast_24h() returns a 96-element list of Watt values
- [x] ConsumptionForecaster.is_ready returns False before 24h of data
- [x] ConsumptionForecaster.apply_correction() adjusts correction_factor within [0.5, 1.5]
- [x] Model file at /data/ uses atomic write (os.rename) and version checking (MODEL_VERSION=1)
- [x] HA entity discovery identifies unconfigured energy entities and logs German warnings
- [x] No new dependencies required (aiohttp, requests, json, threading all already in container)

## Self-Check: PASSED

Files exist:
- evcc-smartload/rootfs/app/forecaster/__init__.py: FOUND
- evcc-smartload/rootfs/app/forecaster/consumption.py: FOUND (368 lines >= 150 minimum)
- evcc-smartload/rootfs/app/forecaster/ha_energy.py: FOUND (342 lines >= 60 minimum)
- evcc-smartload/rootfs/app/forecaster/pv.py: FOUND
- evcc-smartload/rootfs/app/influxdb_client.py: query_home_power_15min and query_home_power_hourly confirmed
- evcc-smartload/rootfs/app/config.py: ha_url and ha_token confirmed

Commits exist:
- 3108c12: feat(03-01): ConsumptionForecaster with tiered aggregation — FOUND
- d118975: feat(03-01): HA energy entity discovery with WebSocket and REST fallback — FOUND
