---
phase: 06-decision-transparency
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - evcc-smartload/rootfs/app/web/static/app.js
autonomous: true
requirements: [TRAN-02, TRAN-01]

must_haves:
  truths:
    - "Plan tab shows an SVG Gantt chart with colored bars for battery charge (green), battery discharge (orange), EV charge (blue), and PV background (yellow/gold)"
    - "A red/grey price line overlays the Gantt bars showing ct/kWh across the timeline"
    - "Hovering a slot bar shows a compact tooltip with the short explanation"
    - "Clicking a slot bar shows the full long explanation in a detail panel below the chart"
    - "Switching to the Plan tab triggers a fetch to GET /plan and renders the chart"
    - "Rolling 24h window is the default view with time axis labels"
  artifacts:
    - path: "evcc-smartload/rootfs/app/web/static/app.js"
      provides: "renderPlanGantt(), switchTab(), fetchAndRenderPlan() functions"
      contains: "renderPlanGantt"
  key_links:
    - from: "evcc-smartload/rootfs/app/web/static/app.js"
      to: "GET /plan endpoint"
      via: "fetch('/plan') in fetchAndRenderPlan()"
      pattern: "fetch.*['\"/]plan['\"]"
    - from: "evcc-smartload/rootfs/app/web/static/app.js"
      to: "evcc-smartload/rootfs/app/web/templates/dashboard.html"
      via: "DOM references to #planChartWrap, #planDetail, #planNoData, tab-btn, tab-panel"
      pattern: "planChartWrap|planDetail|planNoData"
---

<objective>
Implement the interactive SVG Gantt chart for the Plan tab with price overlay, color-coded action bars, hover tooltips (short explanation), and click-to-expand detail (long explanation). Also implement the tab switching logic in JavaScript.

Purpose: This is the visual heart of TRAN-02 — users see the 24-48h plan as a colored timeline. Combined with TRAN-01 explanations from Plan 01's API, each bar communicates why the decision was made.
Output: Updated app.js with Gantt chart rendering, tooltip interactions, and tab switching
</objective>

<execution_context>
@C:/Users/nicok/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/nicok/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-decision-transparency/06-RESEARCH.md
@.planning/phases/06-decision-transparency/06-01-SUMMARY.md

@evcc-smartload/rootfs/app/web/static/app.js
@evcc-smartload/rootfs/app/web/templates/dashboard.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement switchTab() and fetchAndRenderPlan()</name>
  <files>evcc-smartload/rootfs/app/web/static/app.js</files>
  <action>
Add to app.js (at end, after existing functions):

**`switchTab(name)`:**
- Iterate `['main', 'plan', 'history']`, set `display` of `$('tab-' + t)` to `''` or `'none'`
- Toggle `.active` class on `.tab-btn` elements: loop `document.querySelectorAll('.tab-btn')`, check `data-tab` attribute or index match
- If `name === 'plan'`: call `fetchAndRenderPlan()`
- If `name === 'history'`: call `fetchAndRenderHistory()` (stub for Plan 03 — `function fetchAndRenderHistory() { /* Plan 03 */ }`)

**`fetchAndRenderPlan()`:**
- `fetch('/plan')` → parse JSON
- If `!data.available || !data.slots.length`:
  - Show `$('planNoData')`, hide `$('planChartWrap')`
  - Return
- Hide `$('planNoData')`, show `$('planChartWrap')`
- Call `renderPlanGantt(data.slots, data.computed_at)`
- Store `window._planSlots = data.slots` for click-detail access

**Update tab-btn elements in dashboard.html (from Plan 01) to include `data-tab` attributes:**
If Plan 01 didn't add `data-tab`, the `switchTab` function should use index-based matching (buttons are in known order: main=0, plan=1, history=2).

Note: Use `var` declarations (not `const`/`let`) for ES5 compatibility consistent with the existing codebase.
  </action>
  <verify>
    <automated>cd C:/users/nicok/projects/smartload &amp;&amp; grep -c "switchTab" evcc-smartload/rootfs/app/web/static/app.js &amp;&amp; grep -c "fetchAndRenderPlan" evcc-smartload/rootfs/app/web/static/app.js</automated>
    <manual>Verify switchTab toggles tab-panel visibility and triggers data fetch</manual>
  </verify>
  <done>switchTab() toggles tab visibility and triggers data fetching; fetchAndRenderPlan() fetches /plan and calls renderPlanGantt; stub for fetchAndRenderHistory exists</done>
</task>

<task type="auto">
  <name>Task 2: Implement renderPlanGantt() SVG chart with tooltip and click-detail</name>
  <files>evcc-smartload/rootfs/app/web/static/app.js</files>
  <action>
Add `renderPlanGantt(slots, computedAt)` function to app.js. Follow the SVG string-concatenation pattern from existing `renderChart()` and `renderForecastChart()`.

**SVG structure (viewBox="0 0 960 250"):**
- Margins: left=50 (for time labels), right=20, top=25, bottom=35
- Plot area: `plotW = 960 - 50 - 20 = 890`, `plotH = 250 - 25 - 35 = 190`
- Each slot bar width: `slotW = plotW / slots.length` (96 slots = ~9.3px each)

**Bars (bottom-up stacking within each slot column):**

For each slot, determine action type and draw colored rect:
1. **Battery charge** (`bat_charge_kw > 0.1`): Green fill `#00ff88`, opacity 0.85
   - Bar height proportional to kW: `barH = (bat_charge_kw / maxPower) * plotH`
   - y from bottom of plot area upward
2. **Battery discharge** (`bat_discharge_kw > 0.1`): Orange fill `#ff8800`, opacity 0.85
3. **EV charge** (`ev_charge_kw > 0.1`): Blue fill `#4488ff`, opacity 0.85
   - Stack above battery bar if both present

Calculate `maxPower` as max of all `bat_charge_kw`, `bat_discharge_kw`, `ev_charge_kw` across all slots (minimum 1.0 to avoid division by zero).

**PV background** (`pv_kw > 0.1`): Yellow/gold fill `#ffd700`, opacity 0.2 — full-width light background bars behind action bars. Draw PV bars FIRST so action bars overlay them.

**Price line** (red/grey `<path>`):
- Compute maxPrice from all `price_ct` values
- Draw polyline over all slots: y = `marginT + plotH - (price_ct / maxPrice) * plotH`
- Stroke: `#ff4444`, width 1.5, no fill

**Time axis labels (bottom):**
- Every 4 slots (= every hour), show time label: parse `start_iso` with `new Date()`, format as `HH:MM` using `getHours()` and `getMinutes()`
- Show labels every 2-3 hours to avoid crowding (every 8-12 slots)

**Y-axis labels (left):**
- Show max power (kW) at top, 0 at bottom
- Show price axis on right side: max price (ct) at top

**Legend:**
- Below chart: colored squares with labels: "Batterie laden", "Batterie entladen", "EV laden", "PV-Erzeugung", "Preis"

**Tooltip (hover — short explanation):**
- Add class `plan-slot` and `data-idx` attribute to each action bar rect
- After SVG is inserted into `$('planChartWrap').innerHTML`, attach event listeners:
  - `mouseenter`: create/show tooltip div with `slot.explanation_short` text
  - `mousemove`: position tooltip relative to chart wrapper (follow mouse, overflow-protect like existing chart tooltip pattern)
  - `mouseleave`: hide tooltip
- Tooltip div: absolute positioned, dark background, white text, padding 6px 10px, border-radius 4px, z-index 100, max-width 280px

**Click detail (long explanation):**
- On `click` of a plan-slot rect:
  - Read `data-idx` to get slot index
  - Read `window._planSlots[idx]` for full slot data
  - Populate `$('planDetail')`: show slot time, all values (price, power, SoC), and `explanation_long` as full paragraph
  - Format: card-style div with slot time as header, values as key-value pairs, explanation as body text
  - Show `$('planDetail')`, scroll to it
- Clicking same slot again or another slot updates the detail panel

Use `var` declarations and `.addEventListener` (not arrow functions) for ES5 compatibility.
  </action>
  <verify>
    <automated>cd C:/users/nicok/projects/smartload &amp;&amp; grep -c "renderPlanGantt" evcc-smartload/rootfs/app/web/static/app.js &amp;&amp; grep -c "plan-slot" evcc-smartload/rootfs/app/web/static/app.js &amp;&amp; grep -c "explanation_short" evcc-smartload/rootfs/app/web/static/app.js</automated>
    <manual>Verify SVG rendering includes colored bars, price line, time labels, and tooltip event handlers</manual>
  </verify>
  <done>SVG Gantt chart renders 96 slots with color-coded bars (green=bat charge, orange=bat discharge, blue=EV, gold=PV), red price overlay line, time axis labels, hover tooltips showing short explanations, click-to-expand showing long explanations in detail panel</done>
</task>

</tasks>

<verification>
1. Switching to Plan tab triggers `/plan` fetch and renders SVG chart
2. Chart shows colored bars matching the user's color scheme: green, orange, blue, gold, red
3. Hovering a bar shows compact German tooltip with price, rank, and cost info
4. Clicking a bar shows full explanation in detail panel below chart
5. Empty state ("Kein Plan verfügbar") shown when no plan is available
6. Time axis shows local time labels (German timezone handled correctly by JS Date)
7. No regressions in existing chart functions (renderChart, renderForecastChart)
</verification>

<success_criteria>
- Plan tab displays interactive SVG Gantt chart with all 4 bar types + price line
- Progressive disclosure works: hover=short, click=long explanation
- Chart is responsive (viewBox-based SVG) and matches project styling
- Tab switching is smooth and data loads on-demand
</success_criteria>

<output>
After completion, create `.planning/phases/06-decision-transparency/06-02-SUMMARY.md`
</output>
