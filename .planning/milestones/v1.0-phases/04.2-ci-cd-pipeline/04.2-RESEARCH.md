# Phase 4.2: CI/CD Pipeline - Research

**Researched:** 2026-02-22
**Domain:** GitHub Actions, GHCR, Home Assistant Add-on Container Publishing
**Confidence:** HIGH

## Summary

Phase 4.2 closes DEPLOY-01 — the single blocker preventing the add-on from being installable on Home Assistant OS devices. The root cause is that `config.yaml` has no `image:` key and there is no GitHub Actions workflow to build and push container images. Without pre-built images on GHCR, HA Supervisor cannot pull the add-on (HA OS devices have no local Docker build capability).

The solution has two parts: (1) add an `image:` key to `evcc-smartload/config.yaml` using the `{arch}` placeholder format HA Supervisor expects, and (2) create a `.github/workflows/` pipeline that builds multi-arch images using `home-assistant/builder` and pushes them to GHCR. Authentication uses `secrets.GITHUB_TOKEN` with `packages: write` permission — no PAT required.

The critical operational pitfall discovered in research is that GHCR packages default to private even when the repository is public. HA Supervisor pulls images anonymously without authentication, so the GHCR package visibility must be manually changed to "Public" after the first push. This is not automated and is the most common cause of "denied" errors when installing community add-ons.

**Primary recommendation:** Use `home-assistant/builder@2025.09.0` (not latest 2025.11.0 — see armv7 section below) with the `--all` flag triggered on GitHub Release publication. Add `image: ghcr.io/krinco1/ha_addon_evcc-smartload-{arch}` to `config.yaml`. Document the post-first-push package-visibility step explicitly.

## Standard Stack

### Core

| Tool | Version | Purpose | Why Standard |
|------|---------|---------|--------------|
| `home-assistant/builder` | `2025.09.0` | HA-native multi-arch cross-compile builder | Official HA tool; handles BUILD_FROM substitution, HA base image resolution, cross-arch QEMU transparently |
| `docker/login-action` | `v3` | GHCR authentication | Required before builder push; uses GITHUB_TOKEN |
| `actions/checkout` | `v4` | Repository checkout | Standard; v6 shown in HA builder docs but v4 is current |

### Supporting

| Tool | Version | Purpose | When to Use |
|------|---------|---------|-------------|
| `docker/metadata-action` | `v5` | Generate semver tags and OCI labels | Use if switching to generic buildx approach instead of HA builder |
| `docker/setup-qemu-action` | `v3` | ARM emulation for cross-arch builds | Only needed with generic buildx; HA builder handles this internally |
| `docker/setup-buildx-action` | `v3` | Multi-platform Docker builds | Only needed with generic buildx approach |
| `docker/build-push-action` | `v6` | Build and push images | Only needed with generic buildx approach |

### Alternatives Considered

| Instead of | Could Use | Tradeoff |
|------------|-----------|----------|
| `home-assistant/builder` | Generic `docker/buildx` + QEMU | HA builder handles HA-specific `BUILD_FROM` arg substitution, reads `build.yaml` automatically, sets required HA image labels — manual buildx requires replicating all this |
| Release-triggered workflow | Push-to-`main` trigger | Release trigger aligns with HA's assumption that default branch = latest container tag; push trigger builds on every commit (useful for edge channel but adds noise) |
| `GITHUB_TOKEN` | Personal Access Token | GITHUB_TOKEN is short-lived, scoped to the repository, no setup required; PAT is required only if the release event needs to trigger downstream workflows |

## Architecture Patterns

### Recommended Project Structure

```
.github/
└── workflows/
    └── build.yaml          # Single workflow: build + push on release
evcc-smartload/
├── config.yaml             # Add image: key here
├── build.yaml              # Already exists — builder reads this for BUILD_FROM
├── Dockerfile              # Already exists — uses ARG BUILD_FROM
└── ...
```

### Pattern 1: HA Builder Workflow (Recommended)

**What:** Use `home-assistant/builder` GitHub Action which wraps the HA cross-compile Docker builder. It reads `build.yaml` for `BUILD_FROM` arch-specific base images, builds all arches, and pushes to GHCR with correct HA image labels.

**When to use:** All HA add-on projects. The builder handles HA-specific conventions automatically.

**Example:**
```yaml
# Source: home-assistant/builder README + community verified pattern
name: "Build and Publish"

on:
  release:
    types: [published]

jobs:
  publish:
    name: Publish add-on
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push
        uses: home-assistant/builder@2025.09.0
        with:
          args: |
            --all \
            --target evcc-smartload \
            --docker-hub ghcr.io/krinco1
```

**Why `--target evcc-smartload`:** The add-on code lives in `evcc-smartload/` subdirectory, not the repository root. The builder's `--target` flag points to the add-on folder within the checkout.

**Why `--docker-hub ghcr.io/krinco1`:** Despite the flag name, `--docker-hub` accepts any registry namespace. The builder will push images as `ghcr.io/krinco1/<slug>-{arch}:<version>` where `<slug>` is the add-on slug from `config.yaml` and `<version>` is from `config.yaml`'s `version:` field.

### Pattern 2: Optional CI Test Build (On PR/Push)

**What:** A separate job using `--test` flag (no push) validates the build compiles successfully without pushing images.

**When to use:** Optional quality gate — runs on every push/PR to catch Dockerfile errors early.

**Example:**
```yaml
# Source: home-assistant/builder README
name: "CI"

on: [push, pull_request]

jobs:
  build:
    name: Test build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: home-assistant/builder@2025.09.0
        with:
          args: |
            --test \
            --all \
            --target evcc-smartload \
            --docker-hub ghcr.io/krinco1
```

### config.yaml image key

Add this line to `evcc-smartload/config.yaml`:

```yaml
# Source: https://github.com/home-assistant/addons-example/blob/main/example/config.yaml
image: "ghcr.io/krinco1/ha_addon_evcc-smartload-{arch}"
```

**Format explanation:**
- `{arch}` is replaced by HA Supervisor with the device architecture (`amd64`, `aarch64`, `armv7`)
- The dash format (`name-{arch}`) is the HA convention matching how the builder names images
- GitHub converts repository names to lowercase for GHCR — `HA_Addon_EVCC-Smartload` becomes `ha_addon_evcc-smartload`

**Two valid `{arch}` placement formats exist:**
- `ghcr.io/owner/name-{arch}` — arch as suffix in image name (HA official convention, recommended)
- `ghcr.io/owner/{arch}/name` — arch as path segment (also supported, used by some community add-ons)

Use the dash format (`-{arch}`) as it matches what `home-assistant/builder` generates by default.

### Anti-Patterns to Avoid

- **Using `home-assistant/builder@2025.11.0` (latest) for this project:** Release 2025.11.0 removed armv7, i386, and armhf support and removed the `--all` flag. Since this project's `config.yaml` lists armv7, use `2025.09.0` which still supports `--armv7` and `--all`.
- **Forgetting `--target evcc-smartload`:** Without the target flag, the builder looks for `config.yaml`/`build.yaml` in the repository root — they're in the `evcc-smartload/` subdirectory.
- **Using release event without PAT when triggering downstream workflows:** `GITHUB_TOKEN` on a `release` event won't trigger other workflows. For this phase it's fine since we're not triggering further automation.
- **Expecting GHCR packages to be public automatically:** They are private by default. Must be set manually.

## Don't Hand-Roll

| Problem | Don't Build | Use Instead | Why |
|---------|-------------|-------------|-----|
| Multi-arch cross-compilation | Custom QEMU + buildx matrix | `home-assistant/builder` | Builder handles HA base image selection from `build.yaml`, correct `BUILD_FROM` injection, HA-specific labels; recreating this from scratch is error-prone |
| Image tagging convention | Custom tag generation script | Builder reads version from `config.yaml` automatically | Keeps HA version metadata in sync with image tags |
| GHCR authentication | PAT stored in repository secrets | `GITHUB_TOKEN` with `packages: write` | Automatic, scoped, no rotation required |

**Key insight:** The HA builder handles the HA-specific build convention end-to-end. Generic Docker buildx works but requires manually replicating HA's `BUILD_FROM` substitution, label schema, and `build.yaml` parsing.

## Common Pitfalls

### Pitfall 1: GHCR Package Private by Default

**What goes wrong:** After the first successful workflow run, the image exists on GHCR but is private. HA Supervisor pulls images anonymously (no registry login capability). Every install attempt returns `500 Server Error: denied` even though the repository is public.

**Why it happens:** GitHub creates GHCR packages as private by default. Repository visibility and package visibility are independent settings.

**How to avoid:** After the first push, navigate to `github.com/Krinco1/HA_Addon_EVCC-Smartload/pkgs/container/ha_addon_evcc-smartload-amd64` (and other arch variants), go to Package Settings, and change visibility to Public. This must be done once per architecture image.

**Warning signs:** `denied` or `500 Server Error` when trying to install the add-on from HA, even though the GitHub repository is public.

### Pitfall 2: Wrong Builder Version Removes armv7

**What goes wrong:** Using `home-assistant/builder@2025.11.0` or `@master` breaks the armv7 build because that release dropped armv7 support and the `--all` flag.

**Why it happens:** The builder follows HA's platform deprecation schedule. HA deprecated armv7 (Raspberry Pi 2/3 32-bit) in May 2025 and removed it fully in HA release 2025.12.

**How to avoid:** Pin to `home-assistant/builder@2025.09.0` which still supports `--armv7` and `--all`.

**Decision point:** armv7 represents ~0.95% of HA installations as of 2025 and is officially deprecated by HA. The project's current `config.yaml` lists armv7. Planner should decide: keep armv7 (use 2025.09.0) or drop it (use 2025.11.0, smaller support surface). Research recommends keeping it for now since the existing `config.yaml` already declares it and the 2025.09.0 builder still fully supports it.

### Pitfall 3: Subdirectory Add-on Without `--target`

**What goes wrong:** Builder fails to find `config.yaml` or `build.yaml` because it looks in repository root by default.

**Why it happens:** This project has the add-on in `evcc-smartload/` subdirectory, not the repo root.

**How to avoid:** Always pass `--target evcc-smartload` to the builder action.

**Warning signs:** `Error: config.yaml not found` or builder reads wrong config.

### Pitfall 4: Image Name Case Sensitivity

**What goes wrong:** `config.yaml` `image:` key uses uppercase (`HA_Addon_EVCC-Smartload`) but GHCR forces lowercase for namespaces/repository names.

**Why it happens:** GitHub normalizes repository names to lowercase in GHCR paths but the actual GitHub repository URL uses the original casing.

**How to avoid:** Use lowercase in the `image:` key: `ghcr.io/krinco1/ha_addon_evcc-smartload-{arch}`. The builder will also output lowercase-named images.

**Warning signs:** Mismatch between `image:` in `config.yaml` and actual GHCR package names causes HA Supervisor to pull the wrong tag.

### Pitfall 5: Version Tag Must Match config.yaml

**What goes wrong:** The image gets pushed with version tag derived from `config.yaml`'s `version:` field (`6.0.0`), but HA Supervisor expects the tag on the default branch to match. If config.yaml version and the pushed tag don't align, HA may show wrong version or fail to find the image.

**Why it happens:** HA Supervisor uses the version from `config.yaml` to construct the image tag to pull.

**How to avoid:** The `home-assistant/builder` reads `version:` from `config.yaml` automatically and uses it as the image tag. As long as the release is triggered after `config.yaml` version is updated, this is consistent.

## Code Examples

Verified patterns from official sources:

### Complete Build Workflow

```yaml
# .github/workflows/build.yaml
# Source: home-assistant/builder README + community verified pattern (github.com/bokub)
name: "Build and Publish"

on:
  release:
    types: [published]

jobs:
  publish:
    name: Publish add-on
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push all architectures
        uses: home-assistant/builder@2025.09.0
        with:
          args: |
            --all \
            --target evcc-smartload \
            --docker-hub ghcr.io/krinco1
```

### config.yaml image key addition

```yaml
# Add to evcc-smartload/config.yaml after the existing arch: block
# Source: https://github.com/home-assistant/addons-example/blob/main/example/config.yaml
image: "ghcr.io/krinco1/ha_addon_evcc-smartload-{arch}"
```

### Resulting GHCR image paths (what gets pushed)

```
ghcr.io/krinco1/ha_addon_evcc-smartload-amd64:6.0.0
ghcr.io/krinco1/ha_addon_evcc-smartload-aarch64:6.0.0
ghcr.io/krinco1/ha_addon_evcc-smartload-armv7:6.0.0
```

## State of the Art

| Old Approach | Current Approach | When Changed | Impact |
|--------------|------------------|--------------|--------|
| Build and push manually | GitHub Actions automated CI/CD | 2020+ | No manual builds required |
| Docker Hub for HA add-ons | GHCR (`ghcr.io`) | 2022+ | GHCR is now the standard for HA ecosystem |
| `--all` flag covers all arches | Explicit arch flags required | builder 2025.11.0 | `--all` removed; must specify `--amd64 --aarch64` explicitly in latest builder |
| armv7/armhf supported | armv7/armhf deprecated then removed | HA 2025.12 | Only amd64 + aarch64 remain in HA ecosystem going forward |
| DockerHub for base images | `ghcr.io/home-assistant/` base images | 2022+ | All HA base images now on GHCR |

**Deprecated/outdated:**
- `--docker-hub dockerhub-username` pointing to Docker Hub: still works but GHCR is now preferred
- `home-assistant/builder@master`: never pin to master — use explicit version tag for reproducibility
- armv7 base images: `ghcr.io/home-assistant/armv7-base-python:3.13-alpine3.21` still exists but the architecture itself is deprecated in HA ecosystem

## Open Questions

1. **armv7: keep or drop?**
   - What we know: armv7 is in current `config.yaml`; it's ~0.95% of HA installs; HA officially deprecated it May 2025, removed from HA 2025.12; builder 2025.09.0 still supports it
   - What's unclear: Whether the project author wants to continue supporting armv7 users
   - Recommendation: Keep armv7 for now by pinning to builder `2025.09.0`. Add a note that it can be dropped in a future release by upgrading to builder 2025.11.0+. Low effort, low risk to keep.

2. **CI test build (on PR/push) — include or not?**
   - What we know: A `--test` build validates Dockerfile compiles for all arches without pushing; adds ~5-10 min per PR
   - What's unclear: Whether the project author values this vs faster PR cycles
   - Recommendation: Include it. The phase description says "GitHub Actions workflow builds... on push/tag" — a push-triggered test build satisfies the "on push" criterion and provides early feedback.

3. **GHCR package link to repository**
   - What we know: GitHub can link GHCR packages to the source repository for better discoverability; requires a `LABEL` in the Dockerfile
   - What's unclear: The existing `Dockerfile` has no HA image labels
   - Recommendation: The `home-assistant/builder` injects standard HA labels automatically. No manual Dockerfile change needed.

## Sources

### Primary (HIGH confidence)
- `github.com/home-assistant/addons-example/blob/main/example/config.yaml` — canonical `image:` key format with `{arch}` placeholder
- `github.com/home-assistant/builder` README — workflow YAML, supported flags, GHCR usage
- `github.com/home-assistant/builder/releases` — version history, 2025.11.0 armv7 removal confirmed

### Secondary (MEDIUM confidence)
- `github.com/hassio-addons/workflows/blob/main/.github/workflows/app-ci.yaml` — community add-ons workflow pattern; confirmed uses `docker/build-push-action` with matrix
- `github.com/home-assistant/addons-development/blob/master/.github/workflows/builder.yml` — official HA development workflow; uses `home-assistant/builder@2025.11.0` with amd64/aarch64 only
- Community issue `github.com/home-assistant/builder/issues/177` + `community.home-assistant.io/t/how-get-access-for-package-published-into-ghcr-io/743304` — GHCR package private-by-default pitfall documented with real user errors

### Tertiary (LOW confidence)
- Release notes claim for 2025.11.0 removing `--all`: confirmed via GitHub Marketplace page which still lists `--armv7`, suggesting the Marketplace page lags behind release notes. Recommend treating 2025.09.0 as the safe pinned version until this is clarified by direct testing.

## Metadata

**Confidence breakdown:**
- Standard stack: HIGH — official HA builder, documented workflow, GITHUB_TOKEN auth all verified
- Architecture: HIGH — image key format verified from official addons-example; workflow structure from builder README
- Pitfalls: HIGH for GHCR visibility and builder version; MEDIUM for armv7 flag status in latest builder
- armv7 deprecation timeline: HIGH — officially documented by Home Assistant blog May 2025

**Research date:** 2026-02-22
**Valid until:** 2026-04-22 (stable domain — GitHub Actions ecosystem and HA builder are slow-moving)
