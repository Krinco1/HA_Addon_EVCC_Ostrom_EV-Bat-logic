# Phase 4.1: Deploy Configuration - Research

**Researched:** 2026-02-22
**Domain:** Home Assistant add-on configuration — version management, config.yaml schema, repository.yaml
**Confidence:** HIGH

---

<user_constraints>
## User Constraints (from CONTEXT.md)

### Locked Decisions

**Version strategy**
- Bump to 6.0.0 (reflects Phases 1-4 completion)
- Update everywhere: version.py, config.yaml, main.py docstring
- Fix any version inconsistencies found across the codebase

**Config field presentation**
- Expose all LP planner fields in config.yaml options and schema sections
- Use same field names as Config dataclass for consistency
- Include sensible descriptions so HA UI is self-documenting

**Config validation**
- Schema should enforce type and range constraints where obvious (e.g., min_soc 0-100, max_soc 0-100)
- Rely on existing ConfigValidator for cross-field rules (min_soc < max_soc)

**Repository metadata**
- Add channel: stable to repository.yaml
- Fix any other missing or incorrect metadata fields

### Claude's Discretion
- All implementation details: field ordering, description wording, schema types
- Whether descriptions are in German or English (follow existing config.yaml convention)
- Any additional inconsistencies found during implementation — fix them
- Documentation and numbering consistency across all touched files

### Deferred Ideas (OUT OF SCOPE)

None — discussion stayed within phase scope

</user_constraints>

---

## Summary

Phase 4.1 is a pure configuration alignment phase with no new runtime logic. All three gaps it closes (DEPLOY-02, DEPLOY-03, DEPLOY-05) require editing static YAML and Python files only. No new modules, no new tests, no architectural changes. The work is: (1) a version string bump in two files plus a docstring update, (2) adding eight missing fields to config.yaml options+schema+translations, and (3) adding `channel: stable` to repository.yaml.

The primary technical surface is the Home Assistant add-on config.yaml schema language. The schema already in config.yaml is well-formed and uses the correct syntax (`"float(0,)"`, `"int(0,100)"`, `bool`, `url`, `password`). All eight missing fields have confirmed defaults in Config dataclass and confirmed usages in HorizonPlanner/ChargeSequencer. The correct schema types and range bounds for each field are derivable from the Config dataclass definition and existing audit data.

One implementation note: the existing config.yaml uses English field descriptions in translations/en.yaml and German descriptions in translations/de.yaml. The options/schema sections of config.yaml itself carry no descriptions (translations files carry them). New fields must be added to both translation files, following existing patterns.

**Primary recommendation:** Edit four files in one plan. All changes are mechanical — derive types/ranges from Config dataclass, derive descriptions from existing translation patterns, then verify consistency end-to-end.

---

## Standard Stack

### Core

| File | Current State | Change Required |
|------|--------------|-----------------|
| `evcc-smartload/rootfs/app/version.py` | `VERSION = "5.0.7"` | Change to `"6.0.0"` |
| `evcc-smartload/config.yaml` | version: `"5.0.7"`, missing 8 fields | Bump version, add 8 fields to options + schema |
| `repository.yaml` | name/url/maintainer only | Add `channel: stable` |
| `evcc-smartload/rootfs/app/main.py` | docstring says `v6.0` — already correct | Update version references if any hardcoded |
| `evcc-smartload/translations/en.yaml` | 22 fields covered, 8 missing | Add 8 entries |
| `evcc-smartload/translations/de.yaml` | 22 fields covered, 8 missing | Add 8 entries |

### No New Dependencies

This phase installs nothing, adds no Python packages, and does not modify any runtime Python code. All changes are YAML and one string literal in version.py.

---

## Architecture Patterns

### HA Add-on Config Flow

How user-supplied values reach the application:

```
HA Supervisor writes /data/options.json
  → config.py:load_config() reads via json.load()
  → for k,v in raw.items(): if hasattr(cfg, k): setattr(cfg, k, v)
  → ConfigValidator.validate(cfg) checks critical + warning rules
  → main() applies safe defaults for warnings, halts on critical errors
```

Config.dataclass fields without corresponding config.yaml entries simply use their Python default values. This is why the app functions correctly today — all 8 missing fields have defaults. Adding them to config.yaml makes them user-configurable via the HA UI without changing any runtime behavior at default values.

### config.yaml Structure (verified from live file)

```yaml
options:         # default values shown in HA UI
  field_name: default_value

schema:          # validation rules enforced before addon starts
  field_name: "type(min,max)"   # or: bool, str, url, password, port
```

Translations are separate:
```yaml
# translations/en.yaml or de.yaml
configuration:
  field_name:
    name: "Human-readable label"
    description: "Explanation text shown in HA UI"
```

### HA Schema Type Reference (HIGH confidence — official docs)

| Type syntax | Meaning | Example usage |
|-------------|---------|---------------|
| `str` | any string | `str` |
| `int` | any integer | `int` |
| `int(min,max)` | integer in range | `"int(0,100)"` |
| `int(min,)` | integer >= min | `"int(1,)"` |
| `float` | any float | `float` |
| `float(min,max)` | float in range | `"float(0,1)"` |
| `float(min,)` | float >= min | `"float(0,)"` |
| `bool` | boolean | `bool` |
| `bool?` | optional boolean | `bool?` |
| `url` | URL string | `url` |
| `password` | password (masked in UI) | `password` |
| `password?` | optional password | `password?` |
| `str?` | optional string | `str?` |

The `?` suffix marks a field as completely optional (no default required in options block).

### The Eight Missing Fields: Types and Ranges

Derived from Config dataclass (`config.py`) and audit evidence (v1.0-MILESTONE-AUDIT.md):

| Field | Config default | Used by | options value | schema type | Range rationale |
|-------|---------------|---------|---------------|-------------|-----------------|
| `battery_charge_power_kw` | `4.3` | LP formulation — max battery charge rate | `4.3` | `"float(0,)"` | Must be > 0; no hard upper bound (hardware-dependent) |
| `battery_min_soc` | `10` | LP SoC bounds, ConfigValidator | `10` | `"int(0,100)"` | 0–100% SoC range |
| `battery_max_soc` | `90` | LP SoC bounds, ConfigValidator | `90` | `"int(0,100)"` | 0–100% SoC range |
| `feed_in_tariff_ct` | `7.0` | LP objective (revenue for grid export) | `7.0` | `"float(0,)"` | Must be >= 0; can be 0 if no feed-in tariff |
| `ev_default_energy_kwh` | `30.0` | LP EV capacity fallback when real cap unknown | `30.0` | `"float(0,)"` | Must be > 0; typical range 10–100 |
| `sequencer_enabled` | `True` | main.py, server.py — ChargeSequencer on/off | `true` | `bool` | Boolean — no range |
| `sequencer_default_charge_power_kw` | `11.0` | LP, sequencer fallback charge power | `11.0` | `"float(0,)"` | Must be > 0; hardware-dependent ceiling |
| `rl_bootstrap_max_records` | `1000` | RL bootstrap memory cap | `1000` | `"int(1,)"` | Must be >= 1 |

Note: `battery_min_soc` and `battery_max_soc` cross-field validation (min < max) is already handled by `ConfigValidator._check_soc_bounds()`. The schema type `"int(0,100)"` covers per-field bounds correctly.

### Translation Convention (verified from live files)

Existing en.yaml uses English, de.yaml uses German. Pattern: concise name + one-line description. Example:

```yaml
# en.yaml pattern
battery_capacity_kwh:
  name: Battery Capacity (kWh)
  description: Total usable capacity of the home battery in kWh

# de.yaml pattern
battery_capacity_kwh:
  name: Batterie-Kapazität (kWh)
  description: Nutzbare Gesamtkapazität der Hausbatterie in kWh
```

New entries should follow the same pattern. The `(unit)` suffix in `name` is the existing convention for numeric fields with units.

---

## Don't Hand-Roll

| Problem | Don't Build | Use Instead |
|---------|-------------|-------------|
| Cross-field SoC validation (min < max) | New schema logic | Already in `ConfigValidator._check_soc_bounds()` |
| Type coercion from options.json | Manual parsing | Already in `load_config()` via `setattr` loop |
| Per-field range enforcement at runtime | Python guards | HA Supervisor enforces schema before add-on starts |

**Key insight:** The HA Supervisor validates schema BEFORE writing options.json. If a user enters `battery_min_soc: 150`, the Supervisor rejects it at the UI layer. Runtime ConfigValidator handles cross-field rules only.

---

## Common Pitfalls

### Pitfall 1: Boolean field in options block uses wrong YAML literal
**What goes wrong:** Writing `sequencer_enabled: "true"` (string) instead of `sequencer_enabled: true` (YAML boolean) in the options block. Schema enforces `bool` type; mismatched type in options causes Supervisor to reject the config.yaml.
**How to avoid:** Use bare `true`/`false` (not quoted) in options block for boolean fields. Verified pattern: `rl_enabled: true`, `influxdb_ssl: false` in existing config.yaml options block.

### Pitfall 2: Schema `bool?` vs `bool` — options block alignment
**What goes wrong:** Using `bool?` in schema but providing a default in options. Per HA docs, `?` means "no default required" — having a default value in options makes it required. Existing fields `influxdb_ssl: bool?` and `battery_to_ev_dynamic_limit: bool?` and `quiet_hours_enabled: bool?` are optional. The new `sequencer_enabled` field has a clear required default (`true`), so use `bool` (not `bool?`).
**How to avoid:** Use `bool` (not `bool?`) when a sensible default exists in the options block.

### Pitfall 3: Version string quoted in config.yaml
**What goes wrong:** HA config.yaml requires version as a quoted string. `version: 6.0.0` parses as float `6.0` then `.0` (YAML error). `version: "6.0.0"` is correct.
**How to avoid:** Always quote version strings in YAML. Already correct in current config.yaml: `version: "5.0.7"`.

### Pitfall 4: Translation files missing entries
**What goes wrong:** config.yaml schema adds fields but translations/en.yaml and de.yaml are not updated. HA UI shows raw field names instead of human-readable labels. Not a hard error but poor UX.
**How to avoid:** Add entries to both translation files for every new field in config.yaml options/schema.

### Pitfall 5: main.py docstring already says v6.0 — don't double-bump
**What goes wrong:** The main.py docstring already reads `EVCC-Smartload v6.0`. A naive "update everywhere" pass might add a second version mention or create inconsistency.
**How to avoid:** The version string source of truth is `version.py:VERSION`. `main.py` line 47 reads `f"  EVCC-Smartload v{VERSION}"` dynamically — it will display 6.0.0 automatically after version.py is updated. The docstring at line 2 says `v6.0` (correct flavor text). No mechanical update needed beyond version.py and config.yaml.

---

## Code Examples

### Current state (verified by file read)

**version.py** (current):
```python
VERSION = "5.0.7"
```

**version.py** (target):
```python
VERSION = "6.0.0"
```

**config.yaml version line** (current):
```yaml
version: "5.0.7"
```

**config.yaml version line** (target):
```yaml
version: "6.0.0"
```

**repository.yaml** (current):
```yaml
name: "EVCC-Smartload Add-on Repository"
url: "https://github.com/Krinco1/HA_Addon_EVCC-Smartload"
maintainer: "Krinco1"
```

**repository.yaml** (target):
```yaml
name: "EVCC-Smartload Add-on Repository"
url: "https://github.com/Krinco1/HA_Addon_EVCC-Smartload"
maintainer: "Krinco1"
channel: stable
```

### New options block entries (to add after existing options)

```yaml
  battery_charge_power_kw: 4.3
  battery_min_soc: 10
  battery_max_soc: 90
  feed_in_tariff_ct: 7.0
  ev_default_energy_kwh: 30.0
  sequencer_enabled: true
  sequencer_default_charge_power_kw: 11.0
  rl_bootstrap_max_records: 1000
```

### New schema entries (to add after existing schema)

```yaml
  battery_charge_power_kw: "float(0,)"
  battery_min_soc: "int(0,100)"
  battery_max_soc: "int(0,100)"
  feed_in_tariff_ct: "float(0,)"
  ev_default_energy_kwh: "float(0,)"
  sequencer_enabled: bool
  sequencer_default_charge_power_kw: "float(0,)"
  rl_bootstrap_max_records: "int(1,)"
```

### New translation entries (en.yaml)

```yaml
  battery_charge_power_kw:
    name: Battery Charge Power (kW)
    description: Maximum charging power of the home battery in kW
  battery_min_soc:
    name: Battery Min SoC (%)
    description: Minimum battery state of charge — LP planner will not discharge below this
  battery_max_soc:
    name: Battery Max SoC (%)
    description: Maximum battery state of charge — LP planner will not charge above this
  feed_in_tariff_ct:
    name: Feed-in Tariff (ct/kWh)
    description: Revenue per kWh for feeding solar into the grid — used in LP objective
  ev_default_energy_kwh:
    name: EV Default Energy (kWh)
    description: Fallback EV battery capacity when real capacity is unknown
  sequencer_enabled:
    name: Charge Sequencer Enabled
    description: Enable multi-EV charge sequencing (one EV at a time on shared wallbox)
  sequencer_default_charge_power_kw:
    name: Sequencer Default Charge Power (kW)
    description: Default charge power used by sequencer when vehicle-specific power is unavailable
  rl_bootstrap_max_records:
    name: RL Bootstrap Max Records
    description: Maximum InfluxDB records loaded during RL agent bootstrap to cap memory use
```

### New translation entries (de.yaml)

```yaml
  battery_charge_power_kw:
    name: Batterie-Ladeleistung (kW)
    description: Maximale Ladeleistung der Hausbatterie in kW
  battery_min_soc:
    name: Batterie Min-SoC (%)
    description: Minimaler Batterie-Ladezustand — LP-Planer entlädt nicht darunter
  battery_max_soc:
    name: Batterie Max-SoC (%)
    description: Maximaler Batterie-Ladezustand — LP-Planer lädt nicht darüber hinaus
  feed_in_tariff_ct:
    name: Einspeisevergütung (ct/kWh)
    description: Vergütung je kWh für Solareinspeisung — wird im LP-Optimierungsziel verwendet
  ev_default_energy_kwh:
    name: EV Standard-Energie (kWh)
    description: Fallback-Batteriekapazität des EV wenn echte Kapazität unbekannt
  sequencer_enabled:
    name: Charge Sequencer aktiviert
    description: Mehrfach-EV-Ladesequenzierung aktivieren (ein EV gleichzeitig an gemeinsamer Wallbox)
  sequencer_default_charge_power_kw:
    name: Sequencer Standard-Ladeleistung (kW)
    description: Standard-Ladeleistung des Sequencers wenn fahrzeugspezifische Leistung nicht verfügbar
  rl_bootstrap_max_records:
    name: RL Bootstrap Max. Datensätze
    description: Maximale InfluxDB-Datensätze beim RL-Bootstrap zur Speicherbegrenzung
```

---

## State of the Art

| Area | Current State | Target State |
|------|--------------|-------------|
| Version string | `5.0.7` in version.py and config.yaml | `6.0.0` everywhere |
| config.yaml schema | 22 fields, 8 LP/sequencer fields missing | 30 fields, all LP planner fields exposed |
| repository.yaml | name/url/maintainer only | + `channel: stable` |
| Translation files | 22 fields each | 30 fields each |

---

## Open Questions

1. **Field ordering in config.yaml**
   - What we know: existing fields are grouped by logical domain (evcc, influxdb, battery, ev, rl, vehicle, quiet_hours)
   - What's unclear: should new fields be appended at end or inserted into existing groups?
   - Recommendation: Insert into existing groups for readability — `battery_charge_power_kw`, `battery_min_soc`, `battery_max_soc` belong in the `# --- Home battery ---` group; `feed_in_tariff_ct` belongs after battery fields; `ev_default_energy_kwh` in the EV group; `sequencer_enabled`/`sequencer_default_charge_power_kw` as a new sequencer section; `rl_bootstrap_max_records` in RL section. Claude's discretion to decide.

2. **description field in config.yaml itself**
   - What we know: `description` in config.yaml line 4 is the add-on subtitle in HA UI (not per-field descriptions)
   - What's unclear: should the add-on description be updated to mention LP planner?
   - Recommendation: Update to mention LP planner and HorizonPlanner features to reflect v6 capabilities. This is a minor improvement within Claude's discretion.

---

## Files to Change (Complete List)

| File | Change | Gap Closed |
|------|--------|-----------|
| `evcc-smartload/rootfs/app/version.py` | `VERSION = "6.0.0"` | DEPLOY-02 |
| `evcc-smartload/config.yaml` | version → `"6.0.0"`, add 8 options + 8 schema entries | DEPLOY-02, DEPLOY-03 |
| `repository.yaml` | add `channel: stable` | DEPLOY-05 |
| `evcc-smartload/translations/en.yaml` | add 8 field entries | DEPLOY-03 (UX) |
| `evcc-smartload/translations/de.yaml` | add 8 field entries | DEPLOY-03 (UX) |

No Python runtime files change. No tests required (no logic changes).

---

## Sources

### Primary (HIGH confidence)
- Direct file reads: `version.py`, `config.yaml`, `repository.yaml`, `config.py` (Config dataclass), `config_validator.py`, `translations/en.yaml`, `translations/de.yaml`, `main.py` — source of truth for current state and defaults
- `.planning/v1.0-MILESTONE-AUDIT.md` — authoritative gap descriptions with exact field names and defaults for DEPLOY-02, DEPLOY-03, DEPLOY-05
- `.planning/phases/04.1-deploy-configuration/04.1-CONTEXT.md` — locked implementation decisions

### Secondary (MEDIUM confidence)
- WebSearch result: "Home Assistant add-on config.yaml schema types float int range constraints 2025 developers documentation" — schema type reference confirmed `int(min,max)`, `float(min,)`, `bool`, `bool?`, `password?` syntax
- WebSearch result: "Home Assistant add-on repository.yaml channel stable edge beta specification 2025" — confirmed `channel: stable` is valid repository.yaml field; official dev docs URL found

---

## Metadata

**Confidence breakdown:**
- Standard stack: HIGH — all files read directly, no inference needed
- Architecture: HIGH — config flow traced through source code, HA schema syntax confirmed via web search
- Pitfalls: HIGH — derived from actual file content and known HA YAML behavior
- Field details: HIGH — all 8 fields verified in Config dataclass with defaults

**Research date:** 2026-02-22
**Valid until:** 2026-03-22 (HA add-on config format is stable; Config dataclass won't change before this phase executes)
