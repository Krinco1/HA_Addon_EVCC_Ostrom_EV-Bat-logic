---
phase: 05-dynamic-buffer
plan: 02
type: execute
wave: 2
depends_on: [05-01]
files_modified:
  - evcc-smartload/rootfs/app/web/templates/dashboard.html
  - evcc-smartload/rootfs/app/web/static/app.js
  - evcc-smartload/rootfs/app/web/server.py
autonomous: false
requirements: [PLAN-03]

must_haves:
  truths:
    - "Dashboard shows current buffer level and PV confidence in a collapsible widget"
    - "Observation mode banner is visible with countdown, activate-live button, and extend button"
    - "Buffer history line chart shows 7-day buffer level over time"
    - "Expandable event log table shows per-event details: confidence, spread, time, PV, old/new buffer, reason"
    - "Observation-mode events are visually distinguished from live events (muted/dashed style)"
    - "POST /buffer/activate-live and POST /buffer/extend-obs endpoints work"
    - "Buffer section updates live via SSE without page reload"
  artifacts:
    - path: "evcc-smartload/rootfs/app/web/templates/dashboard.html"
      provides: "Buffer section HTML: observation banner, confidence widget, chart container, event log table"
      contains: "bufferCard"
    - path: "evcc-smartload/rootfs/app/web/static/app.js"
      provides: "updateBufferSection(), renderBufferChart(), renderBufferLog() JS functions"
      contains: "updateBufferSection"
    - path: "evcc-smartload/rootfs/app/web/server.py"
      provides: "POST /buffer/activate-live and POST /buffer/extend-obs endpoints"
      contains: "/buffer/activate-live"
  key_links:
    - from: "evcc-smartload/rootfs/app/web/static/app.js"
      to: "SSE data.buffer"
      via: "applySSEUpdate() calls updateBufferSection(msg.buffer)"
      pattern: "updateBufferSection\\(msg\\.buffer\\)"
    - from: "evcc-smartload/rootfs/app/web/static/app.js"
      to: "evcc-smartload/rootfs/app/web/server.py"
      via: "fetch('/buffer/activate-live') and fetch('/buffer/extend-obs')"
      pattern: "fetch.*buffer"
    - from: "evcc-smartload/rootfs/app/web/server.py"
      to: "evcc-smartload/rootfs/app/dynamic_buffer.py"
      via: "buffer_calc.activate_live() and buffer_calc.extend_observation()"
      pattern: "buffer_calc\\."
---

<objective>
Build the dashboard UI for dynamic buffer: observation mode banner with countdown and controls, collapsible confidence widget, 7-day buffer history line chart (SVG), expandable event log table, and POST API endpoints for manual observation mode control.

Purpose: Completes PLAN-03 by making the buffer system fully transparent to the user. Every buffer adjustment is visible with its inputs (PV confidence, price spread, time of day, expected PV). The observation mode countdown and controls let the user manage the transition to live operation. The user decision requires "full input visibility per event" and a "dual view: line chart + expandable detail table."

Output: Updated `dashboard.html` with buffer section, updated `app.js` with chart/table rendering and SSE handler, updated `server.py` with POST endpoints.
</objective>

<execution_context>
@C:/Users/nicok/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/nicok/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-dynamic-buffer/05-RESEARCH.md
@.planning/phases/05-dynamic-buffer/05-01-SUMMARY.md
@evcc-smartload/rootfs/app/web/templates/dashboard.html
@evcc-smartload/rootfs/app/web/static/app.js
@evcc-smartload/rootfs/app/web/server.py
@evcc-smartload/rootfs/app/dynamic_buffer.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Dashboard HTML/CSS buffer section and JS chart/table/SSE integration</name>
  <files>evcc-smartload/rootfs/app/web/templates/dashboard.html, evcc-smartload/rootfs/app/web/static/app.js</files>
  <action>
**dashboard.html changes:**

Add a new buffer section AFTER the existing forecast section. Follow the same CSS variable and dark theme conventions as the forecast card. Use the existing `.chart-card` class for consistent styling.

1. **Observation mode banner** (hidden in live mode):
```html
<div id="bufferObsBanner" class="obs-banner" style="display:none;">
    <span id="bufferObsText">Beobachtungsmodus -- noch X Tage</span>
    <button onclick="activateBufferLive()" class="btn-sm">Jetzt aktivieren</button>
    <button onclick="extendBufferObs()" class="btn-sm">Verlängern (+14 Tage)</button>
</div>
```
Style the banner with amber/yellow background (#fef3c7 or similar), matching the HA warning banner pattern. Buttons are small, unobtrusive.

2. **Buffer card section:**
```html
<div class="chart-card" id="bufferCard" style="display:none;">
    <h3>Dynamischer Puffer</h3>
    <!-- Collapsible confidence widget -->
    <div id="confWidget" class="conf-widget">
        <div id="confSummary" class="conf-summary" onclick="toggleConfDetail()">
            PV-Konfidenz: <span id="confValue">--</span>% &middot;
            Puffer: <span id="bufferValue">--</span>% &middot;
            Modus: <span id="bufferMode">--</span>
        </div>
        <div id="confDetail" class="conf-detail" style="display:none;">
            <div>Preisspreizung: <span id="confSpread">--</span> ct/kWh</div>
            <div>Erwartete PV (4h): <span id="confPv4h">--</span> kWh</div>
            <div>Stunde: <span id="confHour">--</span></div>
        </div>
    </div>
    <!-- Buffer level over time: SVG line chart -->
    <div id="bufferChartContainer" style="height:160px; margin: 12px 0;">
        <svg id="bufferChart" viewBox="0 0 960 160" preserveAspectRatio="none" width="100%" height="100%"></svg>
    </div>
    <!-- Event log table (expandable rows) -->
    <div class="buffer-log-container" style="max-height:300px; overflow-y:auto;">
        <table id="bufferLog" class="buffer-log-table">
            <thead>
                <tr>
                    <th>Zeit</th><th>Konfidenz</th><th>Spread</th>
                    <th>Puffer</th><th>Grund</th><th>Status</th>
                </tr>
            </thead>
            <tbody id="bufferLogBody"></tbody>
        </table>
    </div>
</div>
```

3. **CSS additions** (in the existing `<style>` block):
- `.obs-banner`: amber background, padding 8px 16px, rounded corners, flex layout with gap, margin-bottom 12px
- `.conf-widget`: clickable cursor pointer area
- `.conf-summary`: font-weight 500, padding 8px, hover highlight
- `.conf-detail`: padding 8px 16px, smaller font, muted text color
- `.buffer-log-table`: width 100%, border-collapse, same style as existing tables in the dashboard
- `.buffer-log-table td, th`: padding 4px 8px, text-align left, border-bottom 1px
- `.buffer-log-obs`: observation mode row styling -- opacity 0.6, font-style italic (user wants "Hätte geändert" visually distinguished, muted)
- `.btn-sm`: small button style matching existing dashboard buttons

**app.js changes:**

1. **`updateBufferSection(buffer)` function:**
- If `!buffer` return early (module not loaded)
- Show `#bufferCard` (set display to block/flex)
- Observation banner: show if `buffer.mode === 'observation'`, update text with `buffer.days_remaining` days remaining; hide if mode is "live"
- Confidence widget: update `#confValue`, `#bufferValue`, `#bufferMode` from last log entry
- If buffer has log_recent, update expanded detail (#confSpread, #confPv4h, #confHour) from last entry
- Call `renderBufferChart(buffer.log_recent)`
- Call `renderBufferLog(buffer.log_recent)`

2. **`renderBufferChart(logEntries)` function:**
- SVG line chart in `#bufferChart` (same pure SVG style as the existing forecast chart in app.js)
- X axis: time (from first to last log entry ts), Y axis: buffer % (0-100)
- Draw a polyline path for new_buffer_pct values over time
- Color: green (#22c55e) for the buffer line
- Draw a dashed horizontal line at 20% (practical min) and 10% (hard floor) in muted red
- Observation-mode entries rendered with dashed line style or lower opacity
- Y-axis labels: 0%, 20%, 50%, 100%
- X-axis labels: timestamps at regular intervals (every ~24 entries = 6h)

3. **`renderBufferLog(logEntries)` function:**
- Populate `#bufferLogBody` with rows (most recent first, limit to last 50 for performance)
- Each row: time (HH:MM), confidence (X%), spread (Xct), buffer (old->new%), reason text, applied status
- Observation-mode rows get CSS class `buffer-log-obs` (muted/italic per user's "Hätte geändert" spec)
- Live applied rows show a green checkmark or "Aktiv" label
- Observation rows show "Simulation" label

4. **`toggleConfDetail()` function:**
- Toggle `#confDetail` display between none and block

5. **`activateBufferLive()` function:**
- `fetch('/buffer/activate-live', {method: 'POST'})` then update banner visibility
- Add a confirm dialog: "Dynamischen Puffer jetzt live schalten?"

6. **`extendBufferObs()` function:**
- `fetch('/buffer/extend-obs', {method: 'POST', body: JSON.stringify({days: 14}), headers: {'Content-Type': 'application/json'}})` then update banner text

7. **Extend `applySSEUpdate(msg)`:**
- Add `if (msg.buffer) updateBufferSection(msg.buffer);` alongside existing forecast/state updates (around line 1190 in current app.js)

8. **Initial page load:**
- In the existing fetch chain or DOMContentLoaded, add a call to initially render buffer section if data is available from the first SSE event (no separate fetch endpoint needed -- SSE provides all data)
  </action>
  <verify>
    <automated>cd C:/Users/nicok/projects/smartload && grep -q 'bufferCard' evcc-smartload/rootfs/app/web/templates/dashboard.html && echo "HTML: bufferCard found" && grep -q 'updateBufferSection' evcc-smartload/rootfs/app/web/static/app.js && echo "JS: updateBufferSection found" && grep -q 'renderBufferChart' evcc-smartload/rootfs/app/web/static/app.js && echo "JS: renderBufferChart found" && grep -q 'renderBufferLog' evcc-smartload/rootfs/app/web/static/app.js && echo "JS: renderBufferLog found" && grep -q 'toggleConfDetail' evcc-smartload/rootfs/app/web/static/app.js && echo "JS: toggleConfDetail found" && grep -q 'activateBufferLive' evcc-smartload/rootfs/app/web/static/app.js && echo "JS: activateBufferLive found" && grep -q 'msg.buffer' evcc-smartload/rootfs/app/web/static/app.js && echo "JS: SSE buffer handler found"</automated>
    <manual>Open dashboard in browser, verify buffer section renders with observation banner, confidence widget is collapsible, chart shows buffer history line, log table shows events with observation entries visually muted</manual>
  </verify>
  <done>Dashboard shows buffer card with collapsible confidence widget, observation banner with countdown and control buttons, SVG buffer history chart (7-day), expandable event log table with observation entries visually muted, all updating live via SSE</done>
</task>

<task type="auto">
  <name>Task 2: POST API endpoints for manual observation mode control</name>
  <files>evcc-smartload/rootfs/app/web/server.py</files>
  <action>
Add two POST endpoints in `server.py` `do_POST()` method, following the exact same pattern as the existing `/sequencer/request` and `/sequencer/cancel` handlers.

1. **Provide buffer_calc reference to WebServer:**
- In `server.py` WebServer class constructor (`__init__`), accept an optional `buffer_calc=None` parameter and store as `self.buffer_calc = buffer_calc`
- In `main.py`, pass `buffer_calc=buffer_calc` when constructing WebServer (around the WebServer initialization section)

2. **POST /buffer/activate-live:**
```python
elif path == "/buffer/activate-live":
    if srv.buffer_calc is None:
        self._json({"error": "dynamic buffer disabled"}, 503)
        return
    srv.buffer_calc.activate_live()
    self._json({"ok": True, "mode": "live"})
```

3. **POST /buffer/extend-obs:**
```python
elif path == "/buffer/extend-obs":
    if srv.buffer_calc is None:
        self._json({"error": "dynamic buffer disabled"}, 503)
        return
    days = body.get("days", 14)
    try:
        days = int(days)
        if not 1 <= days <= 90:
            raise ValueError
    except (ValueError, TypeError):
        self._json({"error": "days must be 1-90"}, 400)
        return
    srv.buffer_calc.extend_observation(extra_days=days)
    self._json({"ok": True, "mode": "observation", "extended_days": days})
```

4. **Update main.py WebServer construction** to pass buffer_calc:
- Find the `WebServer(...)` constructor call in main.py
- Add `buffer_calc=buffer_calc` as a keyword argument
  </action>
  <verify>
    <automated>cd C:/Users/nicok/projects/smartload && grep -q '/buffer/activate-live' evcc-smartload/rootfs/app/web/server.py && echo "server.py: activate-live endpoint found" && grep -q '/buffer/extend-obs' evcc-smartload/rootfs/app/web/server.py && echo "server.py: extend-obs endpoint found" && grep -q 'buffer_calc' evcc-smartload/rootfs/app/web/server.py && echo "server.py: buffer_calc reference found" && grep -q 'buffer_calc=buffer_calc' evcc-smartload/rootfs/app/main.py && echo "main.py: buffer_calc passed to WebServer"</automated>
  </verify>
  <done>POST /buffer/activate-live and POST /buffer/extend-obs endpoints exist in server.py, validate input, call buffer_calc methods, return JSON response. WebServer receives buffer_calc reference from main.py. Days parameter validated (1-90 range).</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify dynamic buffer dashboard and observation mode</name>
  <files>evcc-smartload/rootfs/app/web/templates/dashboard.html, evcc-smartload/rootfs/app/web/static/app.js, evcc-smartload/rootfs/app/web/server.py</files>
  <action>
Human verification checkpoint. What was built:
Complete dynamic buffer system: DynamicBufferCalc engine with conservative formula, observation mode (14-day auto-transition), dashboard section with collapsible confidence widget, SVG buffer history chart, expandable event log table, observation banner with activate/extend buttons, and POST API endpoints for mode control.

How to verify:
1. Start the add-on or check the dashboard at the usual URL
2. Verify the "Dynamischer Puffer" card appears in the dashboard
3. Verify the observation mode banner shows "Beobachtungsmodus -- noch X Tage" (should be ~14 days on first run)
4. Click the confidence widget summary line -- verify it expands to show Preisspreizung, Erwartete PV, Stunde
5. Check the buffer chart shows a green line (may be flat initially with only a few data points)
6. Check the event log table shows entries with "Simulation" status (observation mode)
7. Verify observation entries appear muted/italic compared to normal entries
8. Test the "Jetzt aktivieren" button (will switch to live mode -- confirm dialog should appear first)
9. If desired, test "Verlängern" button to extend observation period
10. Check that buffer section updates live when new SSE events arrive (no page reload needed)

Resume signal: Type "approved" or describe issues to fix
  </action>
  <verify>Manual human verification of dashboard UI and observation mode behavior</verify>
  <done>User has visually confirmed: buffer card renders correctly, observation banner with countdown, collapsible confidence widget works, chart shows buffer history, log table shows events with observation styling, buttons trigger mode changes, SSE updates work</done>
</task>

</tasks>

<verification>
1. Dashboard has a "Dynamischer Puffer" card with confidence widget, chart, and log table
2. Observation banner visible in observation mode with countdown and control buttons
3. Confidence widget is collapsible (collapsed = summary line, expanded = full details)
4. Buffer chart renders as SVG line chart with 20% and 10% reference lines
5. Event log shows all events with observation entries visually distinguished (muted/italic)
6. POST /buffer/activate-live switches to live mode
7. POST /buffer/extend-obs extends observation by specified days
8. SSE updates buffer section in real-time
9. All text in German matching existing dashboard language
</verification>

<success_criteria>
- User can see current buffer level, PV confidence, and mode at a glance
- User can drill into details via collapsible widget
- User can review 7-day buffer history in chart form
- User can read per-event inputs in the log table
- User can control observation mode transition via dashboard buttons
- Observation-mode "Hätte geändert" entries are visually distinct from live entries
</success_criteria>

<output>
After completion, create `.planning/phases/05-dynamic-buffer/05-02-SUMMARY.md`
</output>
