---
phase: 06-decision-transparency
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - evcc-smartload/rootfs/app/explanation_generator.py
  - evcc-smartload/rootfs/app/web/server.py
  - evcc-smartload/rootfs/app/web/templates/dashboard.html
autonomous: true
requirements: [TRAN-01, TRAN-02]

must_haves:
  truths:
    - "GET /plan returns JSON with 96 slots including explanation_short and explanation_long for each slot"
    - "Each explanation contains price in ct, price rank, cost delta (ca. EUR), and contextual info (PV, departure, buffer)"
    - "Dashboard HTML has 3-tab navigation: Status, Plan, Historie"
    - "Explanations are in German matching the existing dashboard language"
  artifacts:
    - path: "evcc-smartload/rootfs/app/explanation_generator.py"
      provides: "ExplanationGenerator class with explain() method"
      contains: "class ExplanationGenerator"
    - path: "evcc-smartload/rootfs/app/web/server.py"
      provides: "GET /plan API endpoint"
      contains: "/plan"
    - path: "evcc-smartload/rootfs/app/web/templates/dashboard.html"
      provides: "Tab navigation HTML + Plan/Historie tab containers"
      contains: "tab-plan"
  key_links:
    - from: "evcc-smartload/rootfs/app/web/server.py"
      to: "evcc-smartload/rootfs/app/explanation_generator.py"
      via: "ExplanationGenerator instantiation and explain() call in /plan handler"
      pattern: "explanation_gen\\.explain"
    - from: "evcc-smartload/rootfs/app/web/server.py"
      to: "evcc-smartload/rootfs/app/state_store.py"
      via: "store.get_plan() call in /plan handler"
      pattern: "get_plan\\(\\)"
---

<objective>
Create the ExplanationGenerator Python class that produces German-language slot explanations, add the GET /plan API endpoint that serializes PlanHorizon slots with explanations, and add 3-tab navigation skeleton to dashboard HTML.

Purpose: Backend foundation for decision transparency — the /plan endpoint feeds the Gantt chart (Plan 02) and the explanations fulfill TRAN-01. The tab skeleton enables Plan 02 (Plan tab) and Plan 03 (History tab).
Output: explanation_generator.py, updated server.py with /plan endpoint, updated dashboard.html with tab navigation
</objective>

<execution_context>
@C:/Users/nicok/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/nicok/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-decision-transparency/06-RESEARCH.md

@evcc-smartload/rootfs/app/state.py
@evcc-smartload/rootfs/app/state_store.py
@evcc-smartload/rootfs/app/web/server.py
@evcc-smartload/rootfs/app/web/templates/dashboard.html
@evcc-smartload/rootfs/app/main.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ExplanationGenerator with German-language slot explanations</name>
  <files>evcc-smartload/rootfs/app/explanation_generator.py</files>
  <action>
Create `explanation_generator.py` in `rootfs/app/` with class `ExplanationGenerator`.

**Method: `explain(slot: DispatchSlot, plan: PlanHorizon, departure_hours: float = None) -> dict`**

Returns `{"short": str, "long": str}` with German text.

**Logic per slot action type:**

1. **Battery charge** (`bat_charge_kw > 0.1`):
   - Compute price_ct = `round(slot.price_eur_kwh * 100, 1)`
   - Compute price_rank = position in sorted list of all plan slot prices (1-based)
   - Compute percentile = `round(price_rank / n_slots * 100)`
   - Compute cost_delta: `kwh = slot.bat_charge_kw * 0.25`; compare current price vs min of remaining future slots; `delta_eur = (slot.price_eur_kwh - min_future) * kwh`
   - Compute pv_next_hours: sum of `pv_kw` for next 12 slots (3h), multiply by 0.25 for kWh
   - Short: `"Laden: {price_ct} ct (Rang {rank}/{n}), Puffer {bat_soc_pct}%"` — append departure if provided, append cost delta if positive
   - Long: Full sentence: `"Batterie wird jetzt geladen, weil der Preis mit {price_ct} ct im unteren {percentile}% des Forecasts liegt."` + cost delta + PV expectation

2. **Battery discharge** (`bat_discharge_kw > 0.1`):
   - Short: `"Entladen: {price_ct} ct (Rang {rank}/{n}), Puffer {bat_soc_pct}%"`
   - Long: `"Batterie wird entladen, weil der Preis mit {price_ct} ct im oberen {100-percentile}% liegt und Puffer bei {bat_soc_pct}% ausreichend ist."`

3. **EV charge** (`ev_charge_kw > 0.1`):
   - Short: `"EV laden: {price_ct} ct (Rang {rank}/{n})"` + departure hours if provided + cost delta
   - Long: `"{ev_name} wird jetzt geladen, weil der Preis mit {price_ct} ct im unteren {percentile}% des Forecasts liegt{departure_info}."` + cost delta sentence

4. **Hold** (all powers < 0.1):
   - Short: `"Halten: {price_ct} ct (Rang {rank}/{n})"`
   - Long: `"Kein Handlungsbedarf — Preis bei {price_ct} ct liegt nicht im optimalen Bereich zum Laden oder Entladen."`

**Helper method: `_price_stats(slot, plan) -> dict`** returns `{price_ct, rank, n_slots, percentile, delta_eur, pv_next_3h_kwh}`.

Use `"ca."` before EUR cost deltas (per user decision). Use comma as decimal separator for user-facing ct values in explanations (German convention) but keep the JSON API values as float (dot separator).

NO external dependencies — use only stdlib + existing imports pattern.
  </action>
  <verify>
    <automated>cd C:/users/nicok/projects/smartload &amp;&amp; python -c "import sys; sys.path.insert(0, 'evcc-smartload/rootfs/app'); from explanation_generator import ExplanationGenerator; print('Import OK')"</automated>
    <manual>Verify explain() returns dict with 'short' and 'long' keys</manual>
  </verify>
  <done>ExplanationGenerator class exists with explain() method that returns German short/long explanation dicts for all 4 slot action types (bat_charge, bat_discharge, ev_charge, hold)</done>
</task>

<task type="auto">
  <name>Task 2: Add GET /plan endpoint and 3-tab dashboard navigation</name>
  <files>evcc-smartload/rootfs/app/web/server.py, evcc-smartload/rootfs/app/web/templates/dashboard.html</files>
  <action>
**server.py changes:**

1. Add import: `from explanation_generator import ExplanationGenerator`
2. In `WebServer.__init__()`: instantiate `self.explanation_gen = ExplanationGenerator()`
3. Add `_api_plan(self, plan) -> dict` method:
   - Iterates `plan.slots`, calls `self.explanation_gen.explain(slot, plan)` for each
   - Returns `{"available": True, "computed_at": plan.computed_at.isoformat(), "total_cost_eur": round(plan.solver_fun, 3), "slots": [...]}`
   - Each slot dict: `{t, start_iso, bat_charge_kw, bat_discharge_kw, ev_charge_kw, ev_name, price_ct, pv_kw, bat_soc_pct, ev_soc_pct, explanation_short, explanation_long}`
   - Round numeric fields: kW to 2 decimals, pct to 1 decimal, price_ct = `round(slot.price_eur_kwh * 100, 1)`
4. Add route in `do_GET`:
   ```python
   elif path == "/plan":
       plan = srv._store.get_plan()
       if plan is None:
           self._json({"available": False, "slots": []})
       else:
           self._json(srv._api_plan(plan))
   ```
   Place this alongside existing API routes (after /events, before static file handling).

**dashboard.html changes:**

1. Add tab navigation bar BEFORE the existing main content. Insert right after the `<body>` or main container opening:
   ```html
   <div class="tab-nav">
       <button class="tab-btn active" onclick="switchTab('main')">Status</button>
       <button class="tab-btn" onclick="switchTab('plan')">Plan</button>
       <button class="tab-btn" onclick="switchTab('history')">Historie</button>
   </div>
   ```

2. Wrap ALL existing body content inside `<div id="tab-main" class="tab-panel">...</div>`

3. Add empty tab panels after tab-main:
   ```html
   <div id="tab-plan" class="tab-panel" style="display:none;">
       <div class="card"><h2>24h Plan-Timeline</h2><div id="planChartWrap"></div><div id="planDetail" style="display:none;"></div></div>
       <div id="planNoData" style="display:none;" class="card"><p>Kein Plan verfügbar — LP läuft noch oder ist nicht aktiv.</p></div>
   </div>
   <div id="tab-history" class="tab-panel" style="display:none;">
       <div id="historyContent"></div>
       <div id="historyNoData" style="display:none;" class="card"><p>Keine historischen Daten verfügbar.</p></div>
   </div>
   ```

4. Add CSS for tabs (in existing `<style>` block):
   ```css
   .tab-nav { display:flex; gap:4px; margin-bottom:12px; padding:0 8px; }
   .tab-btn { padding:8px 16px; border:1px solid var(--border, #444); background:var(--card-bg, #1a1a2e); color:var(--text, #e0e0e0); border-radius:6px 6px 0 0; cursor:pointer; font-size:14px; border-bottom:none; }
   .tab-btn.active { background:var(--accent, #00d4aa); color:#000; font-weight:bold; }
   .tab-panel { /* no extra styles needed — existing cards handle layout */ }
   ```

Ensure all existing `$('...')` ID references still work — IDs don't change when wrapped in a div. Verify no `display:none` interferes with SSE updates on hidden tabs (SSE updates innerHTML directly, not visibility-dependent).
  </action>
  <verify>
    <automated>cd C:/users/nicok/projects/smartload &amp;&amp; python -c "import sys; sys.path.insert(0, 'evcc-smartload/rootfs/app'); from web.server import WebServer; print('Import OK')" &amp;&amp; grep -c "/plan" evcc-smartload/rootfs/app/web/server.py &amp;&amp; grep -c "tab-plan" evcc-smartload/rootfs/app/web/templates/dashboard.html</automated>
    <manual>Verify /plan endpoint returns JSON, verify tab-nav buttons visible in HTML</manual>
  </verify>
  <done>GET /plan endpoint returns full slot data with explanations; dashboard.html has working 3-tab navigation with Status/Plan/Historie tabs; existing content wrapped in tab-main</done>
</task>

</tasks>

<verification>
1. `GET /plan` returns `{"available": true/false, "slots": [...]}` — each slot has `explanation_short` and `explanation_long`
2. Explanation text is in German, uses "ca." for cost estimates, includes price rank and ct values
3. Dashboard HTML has tab-nav with 3 buttons and 3 tab-panel divs
4. Tab-main wraps all existing content; tab-plan and tab-history are hidden by default
5. No existing JS functionality broken (all IDs preserved)
</verification>

<success_criteria>
- ExplanationGenerator.explain() produces German explanations for all 4 slot types
- GET /plan serializes full PlanHorizon with per-slot explanations
- Dashboard has 3-tab structure visible in HTML
- No regressions in existing dashboard functionality
</success_criteria>

<output>
After completion, create `.planning/phases/06-decision-transparency/06-01-SUMMARY.md`
</output>
