---
phase: 04.2-ci-cd-pipeline
plan: 01
subsystem: infra
tags: [github-actions, ghcr, home-assistant, builder, ci-cd, multi-arch, container]

# Dependency graph
requires:
  - phase: 04.1-deploy-configuration
    provides: config.yaml with version 6.0.0 and 35 HA add-on config fields (including arch: amd64/aarch64/armv7)
provides:
  - config.yaml image key pointing to GHCR with {arch} placeholder for HA Supervisor
  - .github/workflows/build.yaml with CI test build job (push/PR) and publish job (release)
  - Multi-arch image build coverage for amd64, aarch64, armv7
affects: [deployment, DEPLOY-01, HA-add-on-store]

# Tech tracking
tech-stack:
  added:
    - "home-assistant/builder@2025.09.0 — HA-native multi-arch cross-compile builder"
    - "docker/login-action@v3 — GHCR authentication via GITHUB_TOKEN"
    - "actions/checkout@v4 — repository checkout in CI"
  patterns:
    - "HA add-on image key: ghcr.io/{owner}/{slug}-{arch} format with lowercase names"
    - "Builder pinned to 2025.09.0 for armv7 support (2025.11.0+ drops armv7 and --all flag)"
    - "Two-job workflow: build-test (push/PR, no push, --test flag) + publish (release, packages:write)"
    - "--target evcc-smartload required when add-on is in a subdirectory, not repo root"
    - "GITHUB_TOKEN with packages: write — no PAT required for GHCR push"

key-files:
  created:
    - .github/workflows/build.yaml
  modified:
    - evcc-smartload/config.yaml

key-decisions:
  - "Pin home-assistant/builder to 2025.09.0, not latest 2025.11.0 — 2025.11.0 removed armv7 and the --all flag; current config.yaml lists armv7 so we must keep it"
  - "Use --all flag (not explicit arch list) with 2025.09.0 — covers all three arches in one flag, consistent with research recommendation"
  - "CI test build uses --test flag (no push) on push/PR triggers — provides early Dockerfile error detection without polluting GHCR with test images"
  - "GHCR packages default to private — HA Supervisor pulls anonymously; Task 2 (human-action) requires manually setting each arch image to Public after first release push"
  - "Workflow uses if: conditions on event type rather than separate workflow files — single file, clear intent"

patterns-established:
  - "HA add-on CI/CD: always use --target <slug> when add-on is in a subdirectory — builder defaults to repo root"
  - "HA GHCR image naming: ghcr.io/lowercase-owner/lowercase-slug-{arch} — GitHub normalizes repo names to lowercase in GHCR paths"

requirements-completed: []

# Metrics
duration: 1min
completed: 2026-02-22
---

# Phase 4.2 Plan 01: CI/CD Pipeline Summary

**GHCR image key added to config.yaml and GitHub Actions workflow created for multi-arch (amd64/aarch64/armv7) container builds using home-assistant/builder@2025.09.0 — closes the automated build side of DEPLOY-01**

## Performance

- **Duration:** ~1 min
- **Started:** 2026-02-22T20:55:55Z
- **Completed:** 2026-02-22T20:56:39Z
- **Tasks:** 1 (of 2 — Task 2 is human-action checkpoint)
- **Files modified:** 2

## Accomplishments
- DEPLOY-01 (automated side) closed: config.yaml now has `image:` key pointing to GHCR with `{arch}` placeholder — HA Supervisor can resolve images per device architecture
- GitHub Actions workflow created with two jobs: CI test build (push/PR, no push) and publish (release, pushes all 3 arches to GHCR)
- Builder pinned to 2025.09.0 preserving armv7 support — critical since config.yaml declares armv7 and 2025.11.0 removed that architecture
- Zero runtime Python code changed — pure CI/CD infrastructure

## Task Commits

Each task was committed atomically:

1. **Task 1: Add GHCR image key and create GitHub Actions build workflow** - `f62797b` (feat)
2. **Task 2: Set GHCR package visibility to Public** - PENDING (human-action checkpoint — requires GitHub UI after first release)

**Plan metadata:** TBD (docs: complete plan)

## Files Created/Modified
- `evcc-smartload/config.yaml` - Added `image: "ghcr.io/krinco1/ha_addon_evcc-smartload-{arch}"` after arch block (line 10)
- `.github/workflows/build.yaml` - New file: CI test build job + publish job using home-assistant/builder@2025.09.0

## Decisions Made
- Builder pinned to `2025.09.0` (not 2025.11.0 or @master) because the project declares armv7 in config.yaml and 2025.11.0 removed armv7 and the `--all` flag
- `--all` flag used instead of explicit arch list (`--amd64 --aarch64 --armv7`) for conciseness — valid in 2025.09.0
- Single workflow file with `if:` conditions on `github.event_name` rather than two separate workflow files — simpler structure
- `GITHUB_TOKEN` with `packages: write` permission used — short-lived, scoped, no manual PAT rotation required

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered
None.

## User Setup Required

**After the first GitHub Release is published, GHCR packages must be set to Public manually:**

1. Publish a GitHub Release (tag format: `v6.0.0`)
2. Wait for the "Build and Publish" workflow to complete (check Actions tab)
3. Verify all 3 architecture images appear at:
   - `github.com/Krinco1/HA_Addon_EVCC-Smartload/pkgs/container/ha_addon_evcc-smartload-amd64`
   - `github.com/Krinco1/HA_Addon_EVCC-Smartload/pkgs/container/ha_addon_evcc-smartload-aarch64`
   - `github.com/Krinco1/HA_Addon_EVCC-Smartload/pkgs/container/ha_addon_evcc-smartload-armv7`
4. For EACH architecture image: go to Package Settings and change Visibility to "Public"
5. Test: In HA, add repository URL and verify the add-on appears and can be installed

**Why this is required:** GHCR packages are private by default even when the repository is public. HA Supervisor pulls images anonymously (no registry login capability) so packages MUST be public. Failure to do this causes `500 Server Error: denied` when installing from HA.

## Next Phase Readiness
- CI/CD automation is complete — workflow will trigger on next release push
- The `image:` key in config.yaml enables HA Supervisor to locate pre-built images
- Remaining manual step (Task 2 checkpoint): set GHCR package visibility to Public after first release
- Once GHCR packages are public, DEPLOY-01 is fully closed and the add-on is installable on HA OS devices
- Phase 5 (Dynamic Buffer Calculation) can proceed independently of GHCR visibility step

---
*Phase: 04.2-ci-cd-pipeline*
*Completed: 2026-02-22*

## Self-Check: PASSED

- FOUND: evcc-smartload/config.yaml
- FOUND: .github/workflows/build.yaml
- FOUND: .planning/phases/04.2-ci-cd-pipeline/04.2-01-SUMMARY.md
- FOUND commit: f62797b (Task 1)
