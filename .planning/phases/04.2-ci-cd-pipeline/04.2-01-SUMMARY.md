---
phase: 04.2-ci-cd-pipeline
plan: 01
subsystem: infra
tags: [github-actions, ci-cd, multi-arch, container, dockerfile-test]

# Dependency graph
requires:
  - phase: 04.1-deploy-configuration
    provides: config.yaml with version 6.0.0 and 35 HA add-on config fields (including arch: amd64/aarch64/armv7)
provides:
  - .github/workflows/build.yaml with CI test build job (push/PR) — validates Dockerfile builds correctly
  - HA Supervisor builds locally from Dockerfile on device (no pre-built GHCR images)
affects: [deployment, DEPLOY-01, HA-add-on-store]

# Tech tracking
tech-stack:
  added:
    - "home-assistant/builder@2025.09.0 — HA-native multi-arch cross-compile builder (CI test only)"
    - "actions/checkout@v4 — repository checkout in CI"
  patterns:
    - "Builder pinned to 2025.09.0 for armv7 support (2025.11.0+ drops armv7 and --all flag)"
    - "Single-job workflow: build-test (push/PR, --test flag, no push)"
    - "--target evcc-smartload required when add-on is in a subdirectory, not repo root"

key-files:
  created:
    - .github/workflows/build.yaml
  modified:
    - evcc-smartload/config.yaml (image key removed in 99dced7)

key-decisions:
  - "GHCR approach abandoned (99dced7): HA Supervisor was pulling pre-built images instead of building locally — removed image: key and publish job"
  - "CI workflow kept as test-only to validate Dockerfile on push/PR — catches build errors early without publishing"
  - "Standard HA add-on distribution: Supervisor builds locally from Dockerfile on each device"
  - "Pin home-assistant/builder to 2025.09.0 — 2025.11.0 removed armv7 and --all flag"

patterns-established:
  - "HA add-on CI: use --test flag for Dockerfile validation without pushing images"
  - "HA add-on distribution without GHCR: no image: key in config.yaml, Supervisor builds from Dockerfile"

requirements-completed: []

# Metrics
duration: 2min
completed: 2026-02-23
---

# Phase 4.2 Plan 01: CI/CD Pipeline Summary

**CI test workflow created, GHCR pre-built image approach abandoned — HA Supervisor builds locally from Dockerfile (standard add-on distribution model)**

## Performance

- **Duration:** ~2 min (across 2 sessions)
- **Original work:** 2026-02-22 (GHCR image key + publish workflow)
- **Strategy change:** 2026-02-23 (removed GHCR, kept test-only CI)
- **Files modified:** 2

## Accomplishments
- GitHub Actions CI workflow validates Dockerfile builds on push/PR using `--test` flag
- Builder pinned to 2025.09.0 preserving armv7 support
- Zero runtime Python code changed — pure CI infrastructure

## Strategy Change (2026-02-23)

Original plan: pre-built GHCR images pulled by HA Supervisor.
Problem: HA Supervisor pulled pre-built images instead of building from Dockerfile, which is not the intended distribution model for custom add-ons.
Resolution: Removed `image:` key from config.yaml and `publish` job from workflow. HA Supervisor now builds locally from Dockerfile as intended.

Commits:
- `f62797b` — feat: add GHCR image key and CI/CD workflow (original)
- `99dced7` — fix: remove GHCR image key and publish job (strategy change)

## Files Created/Modified
- `.github/workflows/build.yaml` — CI test build job using home-assistant/builder@2025.09.0
- `evcc-smartload/config.yaml` — image key added then removed (net: no change)

## Next Phase Readiness
- CI validates Dockerfile on every push — build errors caught early
- No manual GHCR steps needed (checkpoint eliminated)
- Phase 4.3 (Release Documentation) and Phase 5 (Dynamic Buffer) can proceed

---
*Phase: 04.2-ci-cd-pipeline*
*Completed: 2026-02-23*
