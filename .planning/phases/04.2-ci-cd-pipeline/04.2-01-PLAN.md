---
phase: 04.2-ci-cd-pipeline
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - evcc-smartload/config.yaml
  - .github/workflows/build.yaml
autonomous: false
gap_closure: true
requirements: []

must_haves:
  truths:
    - "config.yaml declares an image key pointing to GHCR with {arch} placeholder"
    - "A GitHub Actions workflow file exists that builds multi-arch images on release publish"
    - "The workflow authenticates to GHCR via GITHUB_TOKEN and pushes images for amd64, aarch64, and armv7"
    - "A CI test build runs on push/PR to catch Dockerfile errors before release"
  artifacts:
    - path: "evcc-smartload/config.yaml"
      provides: "GHCR image reference for HA Supervisor"
      contains: "image:"
    - path: ".github/workflows/build.yaml"
      provides: "GitHub Actions CI/CD pipeline"
      contains: "home-assistant/builder"
  key_links:
    - from: "evcc-smartload/config.yaml"
      to: "GHCR image path"
      via: "image: key with {arch} placeholder"
      pattern: "ghcr\\.io/krinco1/ha_addon_evcc-smartload-\\{arch\\}"
    - from: ".github/workflows/build.yaml"
      to: "evcc-smartload/config.yaml"
      via: "--target evcc-smartload flag reads version from config.yaml"
      pattern: "--target evcc-smartload"
---

<objective>
Add GHCR container image reference to config.yaml and create a GitHub Actions workflow that builds multi-arch (amd64, aarch64, armv7) container images using `home-assistant/builder` and pushes them to GHCR on release publication.

Purpose: Closes DEPLOY-01 (BLOCKER) — without pre-built images on GHCR, HA OS devices cannot install the add-on because they have no local Docker build capability.

Output: Modified config.yaml with image key, new .github/workflows/build.yaml with release-triggered build+push and CI test build jobs.
</objective>

<execution_context>
@C:/Users/nicok/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/nicok/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04.2-ci-cd-pipeline/04.2-RESEARCH.md
@.planning/phases/04.1-deploy-configuration/04.1-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add GHCR image key and create GitHub Actions build workflow</name>
  <files>evcc-smartload/config.yaml, .github/workflows/build.yaml</files>
  <action>
**1. Add `image:` key to `evcc-smartload/config.yaml`:**

Insert the following line after the `arch:` block (after line 9, before `init: false`):

```yaml
image: "ghcr.io/krinco1/ha_addon_evcc-smartload-{arch}"
```

This uses the HA convention: lowercase GHCR namespace, dash-separated `{arch}` suffix. GitHub normalizes the repository name `HA_Addon_EVCC-Smartload` to lowercase `ha_addon_evcc-smartload` in GHCR paths. The `{arch}` placeholder is replaced by HA Supervisor with the device architecture (amd64, aarch64, armv7).

**2. Create `.github/workflows/build.yaml`:**

Create the directory `.github/workflows/` if it does not exist.

Create `.github/workflows/build.yaml` with TWO jobs:

**Job 1: `build-test` (CI test build on push/PR)**
- Trigger: `on: [push, pull_request]`
- Runs on: `ubuntu-latest`
- Steps:
  1. `actions/checkout@v4`
  2. `home-assistant/builder@2025.09.0` with args: `--test --all --target evcc-smartload --docker-hub ghcr.io/krinco1`
- No permissions block needed (no push)
- Purpose: Validates Dockerfile compiles for all architectures without pushing images

**Job 2: `publish` (Build and push on release)**
- Trigger: `on: release: types: [published]`
- Runs on: `ubuntu-latest`
- Permissions: `contents: read`, `packages: write`
- Steps:
  1. `actions/checkout@v4`
  2. `docker/login-action@v3` with registry `ghcr.io`, username `${{ github.repository_owner }}`, password `${{ secrets.GITHUB_TOKEN }}`
  3. `home-assistant/builder@2025.09.0` with args: `--all --target evcc-smartload --docker-hub ghcr.io/krinco1`
- Purpose: Builds multi-arch images and pushes to GHCR with version tag from config.yaml

**CRITICAL constraints (from research):**
- Pin to `home-assistant/builder@2025.09.0` — NOT 2025.11.0 which removed armv7 and `--all` flag
- Use `--target evcc-smartload` because the add-on is in a subdirectory, not repo root
- Use `--docker-hub ghcr.io/krinco1` (despite the flag name, it accepts any registry namespace)
- Use `GITHUB_TOKEN` (not a PAT) — short-lived, scoped, no setup required
- Use lowercase in all GHCR paths (`krinco1`, `ha_addon_evcc-smartload`)
  </action>
  <verify>
1. `grep -c "image:" evcc-smartload/config.yaml` returns 1
2. `grep "ghcr.io/krinco1/ha_addon_evcc-smartload-{arch}" evcc-smartload/config.yaml` shows the image key
3. `cat .github/workflows/build.yaml` shows both jobs (build-test and publish)
4. `grep "home-assistant/builder@2025.09.0" .github/workflows/build.yaml` confirms pinned builder version
5. `grep "\-\-target evcc-smartload" .github/workflows/build.yaml` confirms target flag present in both jobs
6. `grep "\-\-all" .github/workflows/build.yaml` confirms all-arch flag present in both jobs
7. `grep "packages: write" .github/workflows/build.yaml` confirms GHCR push permission on publish job
  </verify>
  <done>
config.yaml has `image: "ghcr.io/krinco1/ha_addon_evcc-smartload-{arch}"` and .github/workflows/build.yaml exists with a CI test build job (push/PR) and a publish job (release) using home-assistant/builder@2025.09.0 targeting evcc-smartload subdirectory for amd64+aarch64+armv7
  </done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 2: Set GHCR package visibility to Public after first release</name>
  <action>
After the first GitHub Release is published and the workflow runs successfully, the GHCR packages will be created as PRIVATE by default. HA Supervisor pulls images anonymously (no registry login) so the packages MUST be set to Public.

This cannot be automated — it requires manual GitHub UI action.
  </action>
  <how-to-verify>
1. Publish a GitHub Release (tag format: e.g., `v6.0.0`)
2. Wait for the "Build and Publish" workflow to complete (check Actions tab)
3. Verify all 3 architecture images appear at:
   - `github.com/Krinco1/HA_Addon_EVCC-Smartload/pkgs/container/ha_addon_evcc-smartload-amd64`
   - `github.com/Krinco1/HA_Addon_EVCC-Smartload/pkgs/container/ha_addon_evcc-smartload-aarch64`
   - `github.com/Krinco1/HA_Addon_EVCC-Smartload/pkgs/container/ha_addon_evcc-smartload-armv7`
4. For EACH architecture image, go to Package Settings and change Visibility to "Public"
5. Test: In HA, add repository URL and verify the add-on appears and can be installed
  </how-to-verify>
  <resume-signal>Type "done" after GHCR packages are set to Public and HA installation verified, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
1. `evcc-smartload/config.yaml` contains `image:` key with correct GHCR path and `{arch}` placeholder
2. `.github/workflows/build.yaml` exists with valid YAML syntax
3. Workflow has two jobs: CI test build (push/PR trigger) and publish (release trigger)
4. Builder pinned to `2025.09.0` (not 2025.11.0 which drops armv7)
5. `--target evcc-smartload` present (subdirectory add-on)
6. `--all` flag builds all 3 architectures (amd64, aarch64, armv7)
7. GHCR auth uses `GITHUB_TOKEN` with `packages: write`
</verification>

<success_criteria>
- config.yaml `image:` key matches GHCR image naming convention expected by HA Supervisor
- GitHub Actions workflow is syntactically valid and uses the recommended HA builder pattern
- Multi-arch support covers all 3 architectures declared in config.yaml (amd64, aarch64, armv7)
- GHCR packages are accessible (public) to HA OS devices for anonymous pull
</success_criteria>

<output>
After completion, create `.planning/phases/04.2-ci-cd-pipeline/04.2-01-SUMMARY.md`
</output>
