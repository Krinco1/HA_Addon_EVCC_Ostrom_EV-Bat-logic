---
phase: 08-residual-rl-and-learning
plan: 05
type: execute
wave: 1
depends_on: [08-04]
files_modified:
  - evcc-smartload/rootfs/app/web/static/app.js
autonomous: true
gap_closure: true
requirements: [LERN-01, LERN-02, LERN-03, LERN-04, TRAN-03]

must_haves:
  truths:
    - "Constraint audit checklist displays individual pass/fail status per check when audit data is available"
    - "All 4 audit checks reflect actual server-side audit results, not always-failed due to format mismatch"
    - "Audit detail text is accessible for each check item"
  artifacts:
    - path: "evcc-smartload/rootfs/app/web/static/app.js"
      provides: "Fixed audit checklist rendering using array iteration instead of dict key lookup"
      contains: "checks\\[ci\\]\\.passed"
  key_links:
    - from: "evcc-smartload/rootfs/app/web/static/app.js"
      to: "/rl-learning"
      via: "fetchAndRenderLernen() consuming data.audit.checks as array"
      pattern: "checks\\[ci\\]"
---

<objective>
Fix the constraint audit checklist display in the Lernen tab dashboard widget.

Purpose: The `_renderLernenWidget()` function in `app.js` accesses `data.audit.checks` by string key (`checks['min_soc']`, `checks['departure_target']`, etc.) but `ResidualRLAgent.run_constraint_audit()` returns `checks` as an array of `{name, passed, detail}` dicts. This causes all 4 audit checks to always display as failed regardless of actual audit results. This is the sole remaining gap from Phase 8 verification.

Output: Fixed `app.js` where audit checks are iterated by array index and `.passed`/`.detail` properties are read correctly from each element.
</objective>

<execution_context>
@C:/Users/nicok/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/nicok/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-residual-rl-and-learning/08-04-SUMMARY.md
@.planning/phases/08-residual-rl-and-learning/08-VERIFICATION.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix audit checklist array-vs-dict mismatch in app.js</name>
  <files>evcc-smartload/rootfs/app/web/static/app.js</files>
  <action>
In `_renderLernenWidget(data)`, locate the audit section (around line 2332-2348).

Current broken code:
```javascript
var auditKeys = ['min_soc', 'departure_target', 'delta_clip', 'win_rate'];
// ...
var checks = data.audit.checks || {};
var allPassed = true;
for (var ci = 0; ci < auditKeys.length; ci++) {
    var passed = checks[auditKeys[ci]];
    // ...
}
```

The server (`run_constraint_audit()`) returns `checks` as an **array** of `{name: str, passed: bool, detail: str}` dicts, not a dict keyed by short IDs.

Replace the audit rendering loop to iterate the checks array by index:

1. Remove the `auditKeys` array entirely — it is no longer needed since the server provides `name` in each check item.
2. Change the `checks` default from `{}` to `[]` (empty array, not empty object).
3. Use `data.audit.all_passed` directly for the overall pass/fail status instead of computing `allPassed` manually — the server already provides this.
4. Iterate `checks` by index: `checks[ci].passed` and `checks[ci].name` (the name IS the German label, e.g., "SoC-Mindestgrenze eingehalten").
5. Optionally add `checks[ci].detail` as a title attribute on the check div for hover tooltip information.
6. Keep the existing `auditLabels` array as a fallback for display labels in case the API response changes, but prefer `checks[ci].name` when available.

The resulting code should look approximately like:

```javascript
if (data.audit !== null && data.audit !== undefined) {
    html += '<h4 style="margin-bottom:8px;color:#e2e8f0;">Sicherheitspr\u00FCfung</h4>';
    var checks = data.audit.checks || [];
    for (var ci = 0; ci < checks.length; ci++) {
        var check = checks[ci];
        var passed = check.passed;
        var label = check.name || auditLabels[ci] || 'Unbekannt';
        var detail = check.detail || '';
        html += '<div class="lernen-audit-check" title="' + detail + '">';
        if (passed) {
            html += '<span class="lernen-audit-pass">&#10003;</span> ' + label;
        } else {
            html += '<span class="lernen-audit-fail">&#10007;</span> ' + label;
        }
        html += '</div>';
    }
    if (data.audit.all_passed) {
        html += '<div style="margin-top:10px;color:#68d391;"><strong>Automatische Bef\u00F6rderung verf\u00FCgbar</strong></div>';
    } else {
        html += '<div style="margin-top:10px;color:#ffaa00;"><strong>Weitere Beobachtung erforderlich</strong></div>';
    }
}
```

Do NOT change anything outside the audit section. The mode badge, metrics, confidence bars, and seasonal cells sections are all correct and must remain untouched.
  </action>
  <verify>
    <automated>cd evcc-smartload && grep -n "checks\[ci\]\.passed" rootfs/app/web/static/app.js && grep -n "checks\[ci\]\.name" rootfs/app/web/static/app.js && echo "PASS: Audit checks accessed by array index with .passed and .name properties" || echo "FAIL: Array access pattern not found"</automated>
    <manual>Open dashboard, click Lernen tab. When audit data is present (after shadow period), verify each of the 4 checks shows individual pass/fail status matching actual server-side audit results, not all-failed.</manual>
    <sampling_rate>run after this task commits, before summary</sampling_rate>
  </verify>
  <done>Audit checklist in Lernen tab correctly displays individual pass/fail status per check by iterating the checks array from the API response. checks[ci].passed and checks[ci].name are used instead of string-key lookup. data.audit.all_passed drives the overall promotion message.</done>
</task>

</tasks>

<verification>
1. `grep -n "auditKeys\[" evcc-smartload/rootfs/app/web/static/app.js` returns no matches (old string-key pattern removed)
2. `grep -n "checks\[ci\]\.passed" evcc-smartload/rootfs/app/web/static/app.js` returns match (new array access pattern)
3. `grep -n "data\.audit\.all_passed" evcc-smartload/rootfs/app/web/static/app.js` returns match (server-provided overall status used)
4. The surrounding audit-pending section (when `data.audit` is null) remains unchanged
5. No other sections of `_renderLernenWidget()` are modified
</verification>

<success_criteria>
- The Lernen tab constraint audit section iterates `data.audit.checks` as an array
- Each check item's `.passed` boolean drives the pass/fail icon display
- Each check item's `.name` provides the German label text
- `data.audit.all_passed` determines the overall promotion/observation message
- All other Lernen tab functionality (mode badge, metrics, confidence bars) is unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/08-residual-rl-and-learning/08-05-SUMMARY.md`
</output>
