---
phase: 08-residual-rl-and-learning
plan: 04
type: execute
wave: 3
depends_on: [08-03]
files_modified:
  - evcc-smartload/rootfs/app/web/server.py
  - evcc-smartload/rootfs/app/web/templates/dashboard.html
  - evcc-smartload/rootfs/app/web/static/app.js
autonomous: true
requirements: [TRAN-03, LERN-01]

must_haves:
  truths:
    - "Dashboard has a 'Lernen' tab showing RL performance vs planner with all labels in German"
    - "Win-rate, daily savings, cumulative savings are visible in the Lernen tab"
    - "Shadow mode countdown shows remaining days in Beobachtung"
    - "Constraint audit checklist is displayed when shadow period has elapsed"
    - "GET /rl-learning endpoint returns mode, win_rate, savings, audit, and forecast confidence data"
    - "Widget shows 'ausstehend' for metrics when insufficient data exists (not NaN or 0%)"
  artifacts:
    - path: "evcc-smartload/rootfs/app/web/server.py"
      provides: "GET /rl-learning and GET /rl-audit endpoints"
      exports: ["_api_rl_learning", "_api_rl_audit"]
    - path: "evcc-smartload/rootfs/app/web/templates/dashboard.html"
      provides: "Fourth tab 'Lernen' with RL widget HTML structure and CSS"
      contains: "tab-lernen"
    - path: "evcc-smartload/rootfs/app/web/static/app.js"
      provides: "fetchAndRenderLernen() function, Lernen tab rendering logic"
      contains: "fetchAndRenderLernen"
  key_links:
    - from: "evcc-smartload/rootfs/app/web/static/app.js"
      to: "/rl-learning"
      via: "fetch() in switchTab('lernen') lazy-load"
      pattern: "fetch.*rl-learning"
    - from: "evcc-smartload/rootfs/app/web/server.py"
      to: "evcc-smartload/rootfs/app/rl_agent.py"
      via: "self.rl (ResidualRLAgent) provides mode, shadow data, audit results"
      pattern: "self\\.rl"
    - from: "evcc-smartload/rootfs/app/web/server.py"
      to: "evcc-smartload/rootfs/app/forecast_reliability.py"
      via: "self.forecast_reliability provides confidence factors"
      pattern: "self\\.forecast_reliability"
---

<objective>
Add the "Lernen" dashboard tab with RL performance metrics, shadow mode countdown, constraint audit checklist, and forecast confidence display. Add the backing API endpoints.

Purpose: TRAN-03 requires the dashboard to show RL vs planner comparison data. LERN-01 completion requires the shadow mode gate and constraint audit to be visible and actionable. All dashboard text in German per locked decision.
Output: GET /rl-learning endpoint, GET /rl-audit endpoint, "Lernen" tab in dashboard.html, rendering logic in app.js
</objective>

<execution_context>
@C:/Users/nicok/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/nicok/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-residual-rl-and-learning/08-RESEARCH.md
@.planning/phases/06-decision-transparency/06-01-SUMMARY.md
@evcc-smartload/rootfs/app/web/server.py
@evcc-smartload/rootfs/app/web/templates/dashboard.html
@evcc-smartload/rootfs/app/web/static/app.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add GET /rl-learning and /rl-audit endpoints to server.py</name>
  <files>evcc-smartload/rootfs/app/web/server.py</files>
  <action>
Add two new API endpoints to web/server.py:

**1. GET /rl-learning endpoint:**

Add `_api_rl_learning()` method and route it from the GET handler.

```python
def _api_rl_learning(self) -> dict:
    """Returns RL learning status for the Lernen tab."""
    agent = getattr(self, 'rl', None)
    seasonal = getattr(self, 'seasonal_learner', None)
    reliability = getattr(self, 'forecast_reliability', None)
    comparator = getattr(self, 'comparator', None)

    # Default response when components unavailable
    result = {
        "mode": "shadow",
        "shadow_days_elapsed": 0,
        "shadow_days_remaining": 30,
        "win_rate_7d": None,
        "avg_daily_savings_eur": None,
        "cumulative_savings_eur": 0.0,
        "audit": None,
        "seasonal_cells_populated": 0,
        "forecast_confidence": {
            "pv": 1.0,
            "consumption": 1.0,
            "price": 1.0,
        },
    }

    if agent is not None:
        shadow_elapsed = agent.shadow_elapsed_days()
        shadow_remaining = max(0, 30 - shadow_elapsed)
        result["mode"] = agent.mode
        result["shadow_days_elapsed"] = shadow_elapsed
        result["shadow_days_remaining"] = shadow_remaining

    if comparator is not None:
        comparisons_7d = comparator.get_recent_comparisons(days=7)
        n = len(comparisons_7d)
        if n >= 10:
            wins = sum(1 for c in comparisons_7d if c.get("rl_better"))
            result["win_rate_7d"] = round(wins / n, 3)
        result["avg_daily_savings_eur"] = comparator.avg_daily_savings()
        result["cumulative_savings_eur"] = round(comparator.cumulative_savings_eur(), 2)

    if agent is not None and agent.shadow_elapsed_days() >= 30:
        result["audit"] = agent.get_audit_result()

    if seasonal is not None:
        result["seasonal_cells_populated"] = seasonal.populated_cell_count()

    if reliability is not None:
        result["forecast_confidence"] = reliability.get_all_confidences()

    return result
```

Route: In the GET handler, add:
```python
elif path == "/rl-learning":
    self._json(self._api_rl_learning())
```

**2. GET /rl-audit endpoint:**

Add `_api_rl_audit()` method returning detailed audit results:

```python
def _api_rl_audit(self) -> dict:
    """Returns detailed constraint audit results."""
    agent = getattr(self, 'rl', None)
    if agent is None:
        return {"available": False}
    audit = agent.get_audit_result()
    if audit is None:
        return {"available": False, "reason": "Shadow period not yet elapsed"}
    return {"available": True, "audit": audit}
```

Route: `elif path == "/rl-audit": self._json(self._api_rl_audit())`

**3. Late attribute declarations in __init__:**
Add `self.seasonal_learner = None`, `self.forecast_reliability = None`, `self.reaction_timing = None` in `__init__()` (they will be set via late attribute injection from main.py, matching the existing pattern for `self.buffer_calc`, `self.override_manager`, etc.).

**4. Guard against None components:** All attribute accesses use `getattr(self, 'attr', None)` pattern or check `is not None` before calling methods. The endpoints must never crash even if learners failed to initialize.

**5. Pitfall 7 guard:** When `n < 10` comparisons exist for win-rate, return `None` (not 0 or NaN). The dashboard will display "ausstehend" for None values.
  </action>
  <verify>
    <automated>cd /c/users/nicok/projects/smartload && python -c "
import ast
src = open('evcc-smartload/rootfs/app/web/server.py').read()
tree = ast.parse(src)
methods = [n.name for n in ast.walk(tree) if isinstance(n, ast.FunctionDef)]
assert '_api_rl_learning' in methods, 'Missing _api_rl_learning method'
assert '_api_rl_audit' in methods, 'Missing _api_rl_audit method'
assert '/rl-learning' in src, 'Missing /rl-learning route'
assert '/rl-audit' in src, 'Missing /rl-audit route'
assert 'seasonal_learner' in src, 'Missing seasonal_learner reference'
assert 'forecast_reliability' in src, 'Missing forecast_reliability reference'
print('PASS: server.py RL endpoints verified')
"
    </automated>
    <manual>Verify server.py has both endpoints with proper None guards</manual>
  </verify>
  <done>GET /rl-learning returns complete RL learning status with mode, win-rate, savings, audit, seasonal, and forecast confidence data. GET /rl-audit returns detailed audit results. Both endpoints handle None components gracefully.</done>
</task>

<task type="auto">
  <name>Task 2: Add "Lernen" tab to dashboard and rendering logic</name>
  <files>
    evcc-smartload/rootfs/app/web/templates/dashboard.html
    evcc-smartload/rootfs/app/web/static/app.js
  </files>
  <action>
**A. Dashboard HTML (dashboard.html):**

1. Add 4th tab button to existing `tab-nav`:
```html
<button class="tab-btn" onclick="switchTab('lernen')">Lernen</button>
```

2. Add `tab-lernen` container after existing tab containers:
```html
<div id="tab-lernen" class="tab-content" style="display:none;">
  <div id="lernenContent">
    <p class="tab-loading">Lade Lerndaten...</p>
  </div>
</div>
```

3. Add CSS for the Lernen tab widgets:
```css
.lernen-mode-badge {
    display: inline-block;
    padding: 4px 12px;
    border-radius: 12px;
    font-weight: bold;
    font-size: 0.9em;
}
.lernen-mode-shadow { background: #2d3748; color: #a0aec0; border: 1px solid #4a5568; }
.lernen-mode-advisory { background: #22543d; color: #68d391; border: 1px solid #48bb78; }
.lernen-metric { margin: 8px 0; font-size: 1.1em; }
.lernen-metric-label { color: #a0aec0; }
.lernen-metric-value { color: #e2e8f0; font-weight: bold; }
.lernen-metric-pending { color: #718096; font-style: italic; }
.lernen-audit-section { margin-top: 16px; padding: 12px; background: #1a202c; border-radius: 8px; }
.lernen-audit-check { margin: 4px 0; }
.lernen-audit-pass { color: #68d391; }
.lernen-audit-fail { color: #fc8181; }
.lernen-audit-pending { color: #a0aec0; }
.lernen-confidence { margin-top: 16px; }
.lernen-confidence-bar { height: 8px; border-radius: 4px; background: #2d3748; margin: 4px 0; }
.lernen-confidence-fill { height: 100%; border-radius: 4px; background: #4299e1; }
```

**B. App.js rendering logic:**

1. Add `fetchAndRenderLernen()` function:

```javascript
function fetchAndRenderLernen() {
    fetch('/rl-learning')
        .then(r => r.json())
        .then(data => {
            var el = document.getElementById('lernenContent');
            if (!el) return;
            el.innerHTML = _renderLernenWidget(data);
        })
        .catch(err => {
            var el = document.getElementById('lernenContent');
            if (el) el.innerHTML = '<p>Fehler beim Laden der Lerndaten.</p>';
        });
}
```

2. Add `_renderLernenWidget(data)` function building the full widget HTML:

**Mode badge:**
- `"shadow"` -> `<span class="lernen-mode-badge lernen-mode-shadow">Beobachtung</span>` + `(noch ${data.shadow_days_remaining} Tage)`
- `"advisory"` -> `<span class="lernen-mode-badge lernen-mode-advisory">Beratung</span>`

**Metrics section (German labels, locked decision):**
- `Gewinnrate (7 Tage):` data.win_rate_7d !== null ? `${Math.round(data.win_rate_7d * 100)}%` : `<span class="lernen-metric-pending">ausstehend</span>`
- `Tagesersparnis (Ø):` data.avg_daily_savings_eur !== null ? `ca. ${data.avg_daily_savings_eur.toFixed(2).replace('.', ',')} EUR` : `<span class="lernen-metric-pending">ausstehend</span>`
- `Kumulierte Ersparnis:` `ca. ${data.cumulative_savings_eur.toFixed(2).replace('.', ',')} EUR`

Note: Use German decimal comma (replace . with ,) throughout. "ca." prefix per existing dashboard convention (Phase 06-01 decision).

**Audit section (shown when data.audit is not null):**
- Header: `Sicherheitsprüfung`
- For each check in audit.checks array, render with pass/fail icon:
  - Pass: `<span class="lernen-audit-pass">&#10003;</span>` + German check label
  - Fail: `<span class="lernen-audit-fail">&#10007;</span>` + German check label
- Audit check labels (German):
  - "SoC-Mindestgrenze eingehalten" (battery min_soc)
  - "Abfahrtsziel eingehalten" (departure target)
  - "Korrekturbereich eingehalten" (delta clip range)
  - "Positive Gewinnrate" (win-rate > 50%)
- If all passed: `<strong>Automatische Beförderung verfügbar</strong>` in green
- If any failed: `<strong>Weitere Beobachtung erforderlich</strong>` in amber

When data.audit is null and mode is shadow:
- Show: `Sicherheitsprüfung (nach ${data.shadow_days_remaining} Tagen)`
- Show 4 pending checks with dash icon and "ausstehend" text

**Forecast confidence section:**
- Header: `Prognose-Qualität`
- Three confidence bars (PV, Verbrauch, Preis):
  - Label + percentage + colored bar (width = confidence * 100%)
  - Bar color: green (>= 0.8), amber (>= 0.5), red (< 0.5)

**Seasonal learner info:**
- `Saisonale Zellen: ${data.seasonal_cells_populated}/48 befüllt`

3. Wire `fetchAndRenderLernen()` into `switchTab()`:

In the existing `switchTab(tabName)` function, add:
```javascript
if (tabName === 'lernen') {
    fetchAndRenderLernen();
}
```

This follows the lazy-load pattern established in Phase 6 for the Plan and Historie tabs.

4. **SSE update (optional):** If an SSE update arrives with RL data, refresh the Lernen tab if it's currently visible. Add to `applySSEUpdate()`:
```javascript
if (document.getElementById('tab-lernen').style.display !== 'none') {
    fetchAndRenderLernen();
}
```
  </action>
  <verify>
    <automated>cd /c/users/nicok/projects/smartload && python -c "
html = open('evcc-smartload/rootfs/app/web/templates/dashboard.html').read()
assert 'tab-lernen' in html, 'Missing tab-lernen container'
assert 'Lernen' in html, 'Missing Lernen tab button'
assert 'lernen-mode' in html or 'lernenContent' in html, 'Missing Lernen widget structure'
js = open('evcc-smartload/rootfs/app/web/static/app.js').read()
assert 'fetchAndRenderLernen' in js, 'Missing fetchAndRenderLernen function'
assert 'rl-learning' in js, 'Missing /rl-learning fetch call'
assert 'Gewinnrate' in js, 'Missing German label Gewinnrate'
assert 'Beobachtung' in js, 'Missing German label Beobachtung'
assert 'ausstehend' in js, 'Missing ausstehend fallback text'
assert 'Tagesersparnis' in js, 'Missing German label Tagesersparnis'
print('PASS: Dashboard Lernen tab verified')
"
    </automated>
    <manual>Open dashboard in browser, click Lernen tab, verify German labels, metrics display, audit checklist, and confidence bars render correctly</manual>
  </verify>
  <done>Dashboard has 4th "Lernen" tab with: mode badge (Beobachtung/Beratung), shadow countdown, Gewinnrate/Tagesersparnis/Kumulierte Ersparnis metrics with "ausstehend" for insufficient data, Sicherheitsprüfung checklist with pass/fail icons, Prognose-Qualität confidence bars, seasonal cell count. All labels in German. Lazy-loaded on tab click via fetch to /rl-learning.</done>
</task>

</tasks>

<verification>
1. GET /rl-learning returns complete JSON with mode, win_rate_7d, savings, audit, confidence data
2. GET /rl-audit returns detailed audit results or unavailable status
3. Both endpoints handle None components (learners not initialized) without crashing
4. Dashboard has 4 tabs: Status, Plan, Historie, Lernen
5. Lernen tab displays mode badge with shadow countdown in German
6. Win-rate shows "ausstehend" when fewer than 10 comparisons exist (Pitfall 7)
7. All German labels match locked decisions: Lernmodus, Beobachtung, Gewinnrate, Tagesersparnis, Kumulierte Ersparnis
8. Audit checklist shows 4 safety checks with pass/fail/pending states
9. Forecast confidence bars show PV, Verbrauch, Preis with colored fill
10. German decimal comma used for all numeric values
</verification>

<success_criteria>
- Dashboard Lernen tab is fully functional with all metrics and German labels
- API endpoints return well-structured JSON with null guards
- Shadow mode countdown correctly shows days remaining
- Audit checklist auto-populates when shadow period ends
- "ca." prefix used for savings estimates (consistent with Phase 6 convention)
- No NaN, ZeroDivisionError, or crash when components have no data yet
</success_criteria>

<output>
After completion, create `.planning/phases/08-residual-rl-and-learning/08-04-SUMMARY.md`
</output>
