---
phase: 04-predictive-planner
plan: 03
type: tdd
wave: 3
depends_on: [04-01, 04-02]
files_modified:
  - evcc-smartload/rootfs/app/test_planner.py
autonomous: true
requirements: [PLAN-01, PLAN-02]

must_haves:
  truths:
    - "When price data changes between cycles, the next plan reflects updated prices (no caching)"
    - "When LP solver fails, system falls back to HolisticOptimizer and logs a warning"
    - "When no EV is connected, LP runs without EV variables and produces battery-only plan"
    - "When departure time is tight (2h), EV gets aggressive charging; when distant (12h), EV waits for cheap slots"
    - "PlanHorizon SoC values respect battery_min_soc and battery_max_soc bounds"
  artifacts:
    - path: "evcc-smartload/rootfs/app/test_planner.py"
      provides: "Integration tests for HorizonPlanner edge cases"
      min_lines: 100
  key_links:
    - from: "evcc-smartload/rootfs/app/test_planner.py"
      to: "evcc-smartload/rootfs/app/optimizer/planner.py"
      via: "import and instantiate HorizonPlanner for testing"
      pattern: "from optimizer.planner import HorizonPlanner"
---

<objective>
Test the HorizonPlanner under realistic edge conditions to verify correctness of the LP formulation and fallback behavior.

Purpose: The LP formulation has many constraint interactions (SoC dynamics, departure deadlines, price optimization, PV surplus). Testing validates that the planner produces economically correct and physically feasible plans. This is critical before the system goes live.

Output: `test_planner.py` with tests covering price-responsive behavior, solver failure fallback, no-EV case, departure urgency, and SoC bounds.
</objective>

<execution_context>
@C:/Users/nicok/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/nicok/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-predictive-planner/04-RESEARCH.md
@.planning/phases/04-predictive-planner/04-01-SUMMARY.md
@.planning/phases/04-predictive-planner/04-02-SUMMARY.md

# Key source files:
@evcc-smartload/rootfs/app/optimizer/planner.py
@evcc-smartload/rootfs/app/state.py
@evcc-smartload/rootfs/app/config.py
</context>

<feature>
  <name>HorizonPlanner integration tests</name>
  <files>evcc-smartload/rootfs/app/test_planner.py, evcc-smartload/rootfs/app/optimizer/planner.py</files>
  <behavior>
Test the HorizonPlanner.plan() method with synthetic inputs to verify:

**Test 1: Basic LP solve with flat prices** (sanity check)
- Input: flat price array (0.30 EUR/kWh for all 96 slots), constant consumption (1.0 kW), no PV, battery at 50% SoC, no EV
- Expected: plan is not None, solver_status == 0, 96 slots in plan, battery should NOT charge (flat price = no arbitrage opportunity)
- Assert: plan.solver_status == 0, len(plan.slots) == 96, all bat_charge_kw near 0

**Test 2: Price valley triggers battery charging**
- Input: high price for slots 0-47 (0.40 EUR/kWh), low price for slots 48-95 (0.10 EUR/kWh), battery at 30% SoC, no EV
- Expected: LP charges battery during cheap slots (48-95), not during expensive slots (0-47)
- Assert: sum of bat_charge_kw for slots 48-95 > sum for slots 0-47

**Test 3: EV departure urgency**
- Input: uniform moderate price (0.25 EUR/kWh), EV connected at 30% SoC, target 80%, departure in 3 hours (12 slots)
- Expected: LP charges EV aggressively in first 12 slots
- Assert: sum of ev_charge_kw for slots 0-11 >> 0, ev_soc at departure_slot >= target (or close)

**Test 4: No EV connected**
- Input: same as Test 1 but with ev_connected=False
- Expected: plan succeeds, no EV charging in any slot
- Assert: all ev_charge_kw == 0 across all slots

**Test 5: Solver failure fallback**
- Input: Deliberately make LP infeasible (e.g., battery_min_soc > battery_max_soc in a test config)
- Expected: plan() returns None (does not raise exception)
- Assert: plan is None

**Test 6: Short price horizon (< 32 slots)**
- Input: tariffs with only 4 hourly slots (16 x 15-min = 16 slots)
- Expected: plan() returns None (insufficient data)
- Assert: plan is None

**Test 7: Battery SoC stays within bounds**
- Input: cheap prices (encourage max charging), battery at 10% SoC, battery_min_soc=10, battery_max_soc=90
- Expected: battery SoC never exceeds 90% in any slot
- Assert: all bat_soc_pct <= 90.5 (allow 0.5% numerical tolerance)
  </behavior>
  <implementation>
Create `test_planner.py` in the app/ directory. Use Python's built-in `unittest` module (no pytest needed — keep Alpine container lightweight).

Build a test harness:
- Create a mock Config object with known battery parameters (capacity 10 kWh, charge power 5 kW, efficiency 0.92, min_soc 10, max_soc 90, ev_max_price_ct 40, battery_max_price_ct 40, ev_charge_deadline_hour 6)
- Create a mock SystemState with known SoC values
- Create synthetic tariff lists in the same format as evcc API: list of dicts with 'start', 'end', 'price' keys (ISO timestamps, EUR/kWh)
- Create 96-element consumption and PV arrays

Each test method:
1. Construct inputs
2. Call `HorizonPlanner(cfg).plan(state, tariffs, consumption_96, pv_96, ev_departure_times)`
3. Assert expected behavior

Run: `python -m unittest test_planner -v` from the app/ directory.

**IMPORTANT:** Tests must be self-contained — no external dependencies (no InfluxDB, no evcc, no network). Only scipy/numpy are needed (already in container).
  </implementation>
</feature>

<verification>
1. `python -m unittest test_planner -v` from app/ directory — all tests pass
2. No tests depend on external services or network
3. Test file is self-contained with mock Config and SystemState
4. At least 7 test methods covering the behaviors listed above
</verification>

<success_criteria>
- All 7+ tests pass with `python -m unittest test_planner -v`
- Tests verify economic correctness (charge during cheap slots, not expensive)
- Tests verify physical feasibility (SoC within bounds, departure constraint met)
- Tests verify fallback behavior (None on solver failure, None on short prices)
- Tests verify no-EV case (no EV charging when disconnected)
- No flaky tests — all assertions use reasonable numerical tolerance (0.5% for SoC, 0.1 kW for power)
</success_criteria>

<output>
After completion, create `.planning/phases/04-predictive-planner/04-03-SUMMARY.md`
</output>
