---
phase: 02-vehicle-reliability
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - evcc-smartload/rootfs/app/rl_agent.py
  - evcc-smartload/rootfs/app/main.py
  - evcc-smartload/rootfs/app/config.py
autonomous: true
requirements:
  - RELI-05

must_haves:
  truths:
    - "RL bootstrap logs progress every 100 records so the user knows startup is not frozen"
    - "RL bootstrap processes at most max_records (default 1000) entries regardless of how much InfluxDB history exists"
    - "RL bootstrap uses the correct price field (price_ct converted to EUR/kWh) instead of always falling back to 0.30"
    - "rl_bootstrap_max_records is configurable via options.json Config field"
  artifacts:
    - path: "evcc-smartload/rootfs/app/rl_agent.py"
      provides: "bootstrap_from_influxdb with max_records cap, progress logging, and price field fix"
      contains: "max_records"
    - path: "evcc-smartload/rootfs/app/config.py"
      provides: "rl_bootstrap_max_records config field with default 1000"
      contains: "rl_bootstrap_max_records"
    - path: "evcc-smartload/rootfs/app/main.py"
      provides: "Bootstrap call passes config max_records value"
      contains: "rl_bootstrap_max_records"
  key_links:
    - from: "evcc-smartload/rootfs/app/main.py"
      to: "rl_agent.bootstrap_from_influxdb()"
      via: "passes max_records from config"
      pattern: "bootstrap_from_influxdb.*max_records"
    - from: "evcc-smartload/rootfs/app/rl_agent.py"
      to: "influx.get_history_hours()"
      via: "fetches history then caps at max_records"
      pattern: "get_history_hours"
    - from: "evcc-smartload/rootfs/app/rl_agent.py"
      to: "logging_util.log"
      via: "progress logging every 100 records"
      pattern: "Loading history.*records"
---

<objective>
Cap RL bootstrap memory usage, add progress logging, and fix the price field bug so bootstrap learns from actual historical prices instead of a constant fallback.

Purpose: RELI-05 ensures the add-on starts in under 3 minutes on a Raspberry Pi, uses less than 256 MB peak memory during RL bootstrap, and logs progress so the user knows startup is not frozen. The price field fix (Pitfall 3 from research) also corrects a silent bug where all bootstrapped experiences used price=0.30 EUR/kWh regardless of actual historical prices.

Output: Modified rl_agent.py with capped and logged bootstrap, modified config.py with new rl_bootstrap_max_records field, modified main.py to pass config value to bootstrap.
</objective>

<execution_context>
@C:/Users/nicok/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/nicok/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-vehicle-reliability/02-RESEARCH.md
@.planning/phases/02-vehicle-reliability/02-01-SUMMARY.md
@evcc-smartload/rootfs/app/rl_agent.py
@evcc-smartload/rootfs/app/main.py
@evcc-smartload/rootfs/app/config.py
@evcc-smartload/rootfs/app/influxdb_client.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add max_records cap, progress logging, and price field fix to bootstrap_from_influxdb()</name>
  <files>evcc-smartload/rootfs/app/rl_agent.py</files>
  <action>
Modify `bootstrap_from_influxdb()` in `rl_agent.py` to add three improvements:

**1. max_records parameter and cap:**
Add `max_records: int = 1000` parameter to the method signature. After fetching data from `influx.get_history_hours(hours)`, cap processing at `max_records`:
```python
total = min(len(data), max_records)
if len(data) > max_records:
    log("warning", f"RL bootstrap: {len(data)} records found, capping at {max_records} (set rl_bootstrap_max_records in config to increase)")
```
Then iterate `data[:max_records]` instead of `data`.

**2. Progress logging:**
At the start of the method, log: `log("info", f"RL bootstrap: fetching up to {hours}h of InfluxDB history...")`
After counting total: `log("info", f"RL bootstrap: processing {total} records...")`
Inside the loop, every 100 records: `log("info", f"RL bootstrap: Loading history: {i}/{total} records")`
At the end: `log("info", f"RL bootstrap: complete -- {learned}/{total} experiences loaded")`
If no data found: `log("info", "RL bootstrap: no history available -- starting fresh")`

Also add a guard for when InfluxDB is not configured: check if `influx` has `_enabled` attribute and if it is False, log `"RL bootstrap: InfluxDB not configured -- skipping"` and return 0.

**3. Price field fix (Pitfall 3):**
Replace the existing price extraction logic. The current code uses `point.get("price")` which returns None (the key is `"price_ct"` in the InfluxDB response dict). Fix to:
```python
price_ct = point.get("price_ct") or point.get("price")
if price_ct is None:
    price = 0.30
elif price_ct > 1.0:  # it's in ct/kWh (e.g. 28.5), convert to EUR/kWh
    price = price_ct / 100
else:  # already in EUR/kWh (legacy field)
    price = price_ct
```
This handles both the current `price_ct` format (ct/kWh) and any legacy `price` field (EUR/kWh) with auto-detection based on the value magnitude.

Keep the existing try/except structure around the entire method. Keep the existing learning logic (Q-table updates, reward calculation, state discretization) unchanged -- only modify the data fetching, iteration bounds, logging, and price extraction.
  </action>
  <verify>
Grep for `max_records` in rl_agent.py -- should appear in the method signature and the slicing logic.
Grep for `Loading history` in rl_agent.py -- should appear in the progress logging line.
Grep for `price_ct` in rl_agent.py -- should appear in the new price extraction logic.
Grep for `RL bootstrap:` in rl_agent.py -- should appear at least 4 times (fetch, processing, complete, no-history).
Verify the method still returns an int (number of learned experiences).
  </verify>
  <done>
bootstrap_from_influxdb() accepts max_records parameter (default 1000), logs progress every 100 records, correctly reads price_ct field from InfluxDB data and converts to EUR/kWh. Memory usage is bounded regardless of history size.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add rl_bootstrap_max_records config field and wire bootstrap call</name>
  <files>evcc-smartload/rootfs/app/config.py, evcc-smartload/rootfs/app/main.py</files>
  <action>
**config.py changes:**
Add `rl_bootstrap_max_records: int = 1000` to the Config dataclass, placed near the other RL-related fields (`rl_memory_size`, `rl_fallback_threshold`, etc.). This follows the existing pattern of RL configuration being part of the Config dataclass with sensible defaults.

Read the file first to find the exact location of existing RL config fields and add the new field adjacent to them.

**main.py changes:**
Find the existing call to `rl_agent.bootstrap_from_influxdb(influx, hours=168)` (or similar). Update it to pass the config value:
```python
max_rec = getattr(cfg, "rl_bootstrap_max_records", 1000)
bootstrapped = rl_agent.bootstrap_from_influxdb(influx, hours=168, max_records=max_rec)
```

Use `getattr()` with default for forward compatibility -- if the Config object does not have the field yet (e.g., running with an older options.json), the default 1000 is used.

Do NOT change any other part of the bootstrap flow in main.py. The existing conditional (`if not rl_agent.load():`) must remain unchanged.
  </action>
  <verify>
Grep for `rl_bootstrap_max_records` in config.py -- should appear as a field definition.
Grep for `rl_bootstrap_max_records` in main.py -- should appear in the getattr call.
Grep for `max_records` in main.py -- should appear in the bootstrap_from_influxdb call.
Verify `rl_agent.load()` conditional is still present and unchanged.
  </verify>
  <done>
Config dataclass has rl_bootstrap_max_records field (default 1000). main.py passes the config value to bootstrap_from_influxdb(). Users can override via options.json. The bootstrap call is backward-compatible via getattr with default.
  </done>
</task>

</tasks>

<verification>
1. `rl_agent.py` bootstrap_from_influxdb() has max_records parameter with default 1000
2. Progress logging appears every 100 records during bootstrap
3. Price extraction uses `price_ct` key (not `price`) with proper conversion
4. `config.py` has `rl_bootstrap_max_records: int = 1000` field
5. `main.py` passes config value to bootstrap via getattr with fallback
6. No new files created -- all changes are modifications to existing files
7. No new dependencies added
</verification>

<success_criteria>
- RL bootstrap is capped at configurable max_records (default 1000), bounding memory usage
- Progress is logged every 100 records so the user sees startup activity on slow hardware
- Price field bug is fixed: bootstrap uses actual historical prices from InfluxDB instead of constant 0.30 EUR/kWh fallback
- Configuration is exposed via options.json for power users who want to tune the cap
</success_criteria>

<output>
After completion, create `.planning/phases/02-vehicle-reliability/02-02-SUMMARY.md`
</output>
